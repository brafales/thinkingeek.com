<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Serverless framework: a small example</title>
  <meta name="description" content="Use case I&#39;ve been willing to give the serverless framework a try for a while, and recently I came up with a small side project that was a potential good fit for it. I am a Monzo user, and I use their card to pay for things like my weekday lunches around the office or my travel expenses like Oyster Card top ups. I also happen to be a user of Toshl, which helps me with my personal finances and budgets. Typically, whenever my Oyster card gets topped up or I pay for a lunch in a restaurant, I then input that expense into Toshl. But turns out both Monzo and Toshl are developer friendly, so I thought I could easily automate that process by having a system that would get certain Monzo expenses directly into Toshl for me, saving me a few seconds per day. A serverless approach was ideal for this, especially since AWS offers a free tier for its services, meaning this would also not cost me a penny.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://thinkingeek.com/2018/10/05/serverless-framework-a-small-example/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Think In Geek" href="https://thinkingeek.com/feed.xml">

  

  
  <meta property="og:title" content="Serverless framework: a small example">
  <meta property="og:site_name" content="Think In Geek">
  <meta property="og:url" content="https://thinkingeek.com/2018/10/05/serverless-framework-a-small-example/">
  <meta property="og:description" content="Use case I&#39;ve been willing to give the serverless framework a try for a while, and recently I came up with a small side project that was a potential good fit for it. I am a Monzo user, and I use their card to pay for things like my weekday lunches around the office or my travel expenses like Oyster Card top ups. I also happen to be a user of Toshl, which helps me with my personal finances and budgets. Typically, whenever my Oyster card gets topped up or I pay for a lunch in a restaurant, I then input that expense into Toshl. But turns out both Monzo and Toshl are developer friendly, so I thought I could easily automate that process by having a system that would get certain Monzo expenses directly into Toshl for me, saving me a few seconds per day. A serverless approach was ideal for this, especially since AWS offers a free tier for its services, meaning this would also not cost me a penny.">
  
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Serverless framework: a small example">
  <meta name="twitter:description" content="Use case I&#39;ve been willing to give the serverless framework a try for a while, and recently I came up with a small side project that was a potential good fit for it. I am a Monzo user, and I us...">
  
  

  <link rel="stylesheet" href="/assets/fonts/fonts.css">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

      <span class="site-title"><a href="/">Think In Geek</a> | </span>
      <span class="site-slogan">In geek we trust</span>

    <nav class="site-nav"><a class="page-link" href="/series/">Series</a><a class="page-link" href="/author/brafales/">Posts by Bernat R√†fales</a><a class="page-link" href="/archives/">Archives</a></nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Serverless framework: a small example</h1>
    
    <p class="post-meta"><time datetime="2018-10-05T09:37:52+00:00" itemprop="datePublished">Oct 5, 2018</time> ‚Ä¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat R√†fales</span></span> ‚Ä¢ <a href="/categories/uncategorized/">Uncategorized</a> ‚Ä¢ <a href="/tags/aws/">aws</a>, <a href="/tags/go/">go</a>, <a href="/tags/serverless/">serverless</a></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2>Use case</h2>

<p>I've been willing to give the <a href="https://www.serverless.com/">serverless framework</a> a try for a while, and recently I came up with a small side project that was a potential good fit for it.</p>

<p>I am a <a href="https://monzo.com/">Monzo</a> user, and I use their card to pay for things like my weekday lunches around the office or my travel expenses like Oyster Card top ups. I also happen to be a user of <a href="https://toshl.com/">Toshl</a>, which helps me with my personal finances and budgets.</p>

<p>Typically, whenever my Oyster card gets topped up or I pay for a lunch in a restaurant, I then input that expense into Toshl. But turns out both Monzo and Toshl are developer friendly, so I thought I could easily automate that process by having a system that would get certain Monzo expenses directly into Toshl for me, saving me a few seconds per day.</p>

<p>A serverless approach was ideal for this, especially since AWS offers a free tier for its services, meaning this would also not cost me a penny.</p>

<!--more-->

<h2>High level design</h2>

<p><a href="https://docs.monzo.com/#webhooks">Monzo provides web hooks</a> that will make an HTTP request to an endpoint of your choice whenever a transaction happens in your account. <a href="https://developer.toshl.com/docs/entries/create/">Toshl also provides an API to create expenses</a>. The way we can tie them together is through a couple of <a href="https://aws.amazon.com/lambda/">AWS Lambdas</a>, one of them being behind an <a href="https://aws.amazon.com/api-gateway/">API Gateway</a>, talking to each other through <a href="https://aws.amazon.com/sns/">SNS notifications</a>. A diagram of the architecture can be found below.</p>

<p><img src="/wp-content/uploads/2018/09/Expenses-App-Architecture1.png" alt="Architecture of the solution" /></p>

<p>In a nutshell the journey will be as follows:</p>

<ol>
<li>Something gets paid with your Monzo card.</li>
<li>Monzo sends a request to an endpoint we have previously configured.</li>
<li>This endpoint goes to an AWS API Gateway, which will map the request to an AWS Lambda named <code>monzo</code>.</li>
<li>The <code>monzo</code> lambda will inspect the transaction that's been created, and determine via very basic rules if it's an expense we'd like to track in Toshl.</li>
<li>If the transaction is of interest, it will then publish a message to an SNS topic with the details of the expense.</li>
</ol>

<p>In parallel to this process, the following will also be happening:
<ol>
<li>Another AWS Lamnda named <code>toshl</code> will be subscribed to the SNS topics where expenses get sent to.</li>
<li>Whenever a message gets published to that topic, the lambda will read the message and make an appropriate HTTP request to the Toshl API so the expense appears in our timeline.</li>
</ol>

<p>We achieve a few things with this approach, amongst them:</p>

<ul>
<li>We decouple Monzo from Toshl. Monzo requests will be handled by a lambda, and if needed that lambda will just publish a message to an SNS topic indicating a new expense has been created.</li>
<li>Similarly, the Toshl lambda knows nothing about Monzo either, it just knows that expenses get published to an SNS topic and it needs to transform them into an HTTP request to be made to the Toshl API. If in the future any other system was interested in knowing about new expenses, we'd only have to plug new lambdas (or any other type of supported receiver) to the SNS topic (e.g. Kafka, DynamoDB, SQS, another SNS topic...).</li>
<li>We only pay for what we need. The API Gateway needs to be always up and running to listen to requests, but we don't pay anything for being idle in any other case. Only when a Monzo transaction happens we'll run a lambda, and only when that transaction is actually relevant to us, we'll then pay for sending a message to SNS, and later on retrieving it and running the <code>toshl</code> lambda.</li>
</ul>

<p>This also means that for the low traffic nature of the system and the <a href="https://aws.amazon.com/free/">AWS Free Tier</a>, we will end up not paying a single penny for all of the above.</p>

<p>All the code explained in this post is available at <a href="https://github.com/brafales/expenses">https://github.com/brafales/expenses</a> and should be ready to run, with the appropriate environment variables set up.</p>

<h2>Creating our infrastructure with the Serverless Framework</h2>

<p>The serverless framework allows you to define all the moving pieces you need fairly easily. I'll show you the final serverless.yml file of the project while explaining all the sections individually. While most of it is standard, I used a couple of third party plugins to enable the use of my own domain in API Gateway and to configure an SQS dead letter queue for the <code>toshl</code> lambda (more on dead letter queues later).</p>


<figure class="highlight"><figcaption>serverless.yml</figcaption><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span class="na">service</span><span class="pi">:</span> <span class="s">${self:custom.environment.service}</span>
<span class="na">app</span><span class="pi">:</span> <span class="s">${self:custom.environment.app}</span>
<span class="na">tenant</span><span class="pi">:</span> <span class="s">${self:custom.environment.tenant}</span>

<span class="na">frameworkVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&gt;=1.28.0</span><span class="nv"> </span><span class="s">&lt;2.0.0"</span>

<span class="na">provider</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
  <span class="na">runtime</span><span class="pi">:</span> <span class="s">go1.x</span>

  <span class="na">stage</span><span class="pi">:</span> <span class="s">dev</span>

  <span class="c1"># Allow IAM role to publish to the SNS topic</span>
  <span class="na">iamRoleStatements</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
      <span class="na">Action</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">SNS:Publish</span>
      <span class="na">Resource</span><span class="pi">:</span> <span class="s">${self:custom.snsTopicArn}</span>
    <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
      <span class="na">Action</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">SQS:SendMessage</span>
      <span class="na">Resource</span><span class="pi">:</span> <span class="s">${self:custom.sqsToshlDLQArn}</span>

<span class="na">plugins</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">serverless-domain-manager</span>
  <span class="pi">-</span> <span class="s">serverless-plugin-lambda-dead-letter</span>

<span class="na">custom</span><span class="pi">:</span>
  <span class="na">environment</span><span class="pi">:</span> <span class="s">${file(env.yml)}</span>
  <span class="na">customDomain</span><span class="pi">:</span>
    <span class="na">domainName</span><span class="pi">:</span> <span class="s">${self:custom.environment.domainName}</span>
    <span class="na">basePath</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">stage</span><span class="pi">:</span> <span class="s">${self:provider.stage}</span>
    <span class="na">createRoute53Record</span><span class="pi">:</span> <span class="no">true</span>

  <span class="c1"># SNS/SQS configuration</span>
  <span class="na">snsTopic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${self:service}-${self:provider.stage}-expense-created"</span>
  <span class="na">snsTopicArn</span><span class="pi">:</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Fn::Join"</span> <span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">,</span> <span class="pi">[</span><span class="s2">"</span><span class="s">arn:aws:sns:${self:provider.region}:"</span><span class="pi">,</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Ref"</span> <span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::AccountId"</span> <span class="pi">},</span> <span class="s2">"</span><span class="s">:${self:custom.snsTopic}"</span> <span class="pi">]</span> <span class="pi">]</span>  <span class="pi">}</span>
  <span class="na">sqsToshlDLQ</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${self:custom.snsTopic}-toshl-dlq"</span>
  <span class="na">sqsToshlDLQArn</span><span class="pi">:</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Fn::Join"</span> <span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">,</span> <span class="pi">[</span><span class="s2">"</span><span class="s">arn:aws:sqs:${self:provider.region}:"</span><span class="pi">,</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Ref"</span> <span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::AccountId"</span> <span class="pi">},</span> <span class="s2">"</span><span class="s">:${self:custom.sqsToshlDLQ}"</span> <span class="pi">]</span> <span class="pi">]</span>  <span class="pi">}</span>

<span class="na">package</span><span class="pi">:</span>
 <span class="na">exclude</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="s2">"</span><span class="s">./**"</span>
 <span class="na">include</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="s2">"</span><span class="s">./bin/**"</span>

<span class="na">functions</span><span class="pi">:</span>
  <span class="na">monzo</span><span class="pi">:</span>
    <span class="na">handler</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bin/monzo"</span>
    <span class="na">events</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api/v1/create"</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s2">"</span><span class="s">post"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">snsTopicArn</span><span class="pi">:</span> <span class="s">${self:custom.snsTopicArn}</span>
      <span class="na">categoryData</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/CategoryData}</span>

  <span class="na">toshl</span><span class="pi">:</span>
    <span class="na">handler</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bin/toshl"</span>
    <span class="na">events</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">sns</span><span class="pi">:</span> <span class="s">${self:custom.snsTopic}</span>
    <span class="na">deadLetter</span><span class="pi">:</span>
      <span class="na">sqs</span><span class="pi">:</span> <span class="s">${self:custom.sqsToshlDLQ}</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">snsTopicArn</span><span class="pi">:</span> <span class="s">${self:custom.snsTopicArn}</span>
      <span class="na">token</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/ToshlToken~true}</span>
      <span class="na">accountId</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/ToshlAccountId}</span>
      <span class="na">categoryData</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/CategoryData}</span>
</pre></td></tr></tbody></table></code></pre></figure>


<p>The first three lines are serverless parameters. You can have different applications in your account, and an application can be composed of one or more services. For this example, we will just have one application and one service. The <code>tenant</code> parameter is linked to your username in the serverless dashboard.</p>

<p>As you can see the values for these parameters are not hardcoded, but instead have the form <code>${self:custom.environment.variable_name}</code>. This is the pattern the serverless framework uses to interpolate environment variables into your yml file. On line 29, you can see that under the <code>custom</code> key we have <code>environment: ${file(env.yml)}</code>. What this will do is read the <code>env.yml</code> file from the current directory, and make its contents available under the <code>self:custom.environment</code> key for you to use throughout the rest of the <code>serverless.yml</code> file. This way you can have your <code>env.yml</code> on the <code>.gitignore</code> file and ensure your sensitive data does not get leaked. This means than in order for this example to work, you'll have to create your own <code>env.yml</code> file. Find below a sample one:</p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">service</span><span class="pi">:</span> <span class="s">expenses</span>
<span class="na">app</span><span class="pi">:</span> <span class="s">expenses</span>
<span class="na">tenant</span><span class="pi">:</span> <span class="s">your_serverless_user</span>
<span class="na">domainName</span><span class="pi">:</span> <span class="s">your-custom-domain.com</span></code></pre></figure>


<p>Moving on to line 5, we can tell serverless what framework versions our service is compatible with.</p>

<p>Lines 7 to 26 set the provider configuration. The serverless framework supports a few of them. For our example, we'll use <code>aws</code>, and also for our lambdas we will use the <code>go1.x</code> runtime (at the time of writing this post, AWS Lambda supported Go, Node.js, Java, Python and .NET Core).</p>

<p>Serverless also allows you to have different stages for deployment. These are like development environments, so you could have a development stage, a staging stage, and a production stage, for example. Again, in our case we'll just stick to one stage and we'll call it <code>dev</code>.</p>

<p>Lines 14 to 22 are interesting. By default, the serverless framework will manage <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html">IAM Roles for you</a>. These roles will control what permissions each of the created artifacts will have. In our use case, we need to ensure that the API Gateway has permissions to invoke the <code>monzo</code> lambda, and so under the hood, serverless will ensure that the permission <code>lambda:InvokeFunction</code> is set to <code>Allow</code> for the <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">Arn</a> of our <code>monzo</code> lambda. However, sometimes you may be interested in adding permissions outside of what is automatically managed by the framework. If we look back at our architecture, we'll see that the <code>monzo</code> lambda will need to publish messages to an SNS topic. And the <code>toshl</code> lambda will need to publish to SQS for its dead letter queue (where messages we failed to process will go for inspection). Serverless doesn't yet provide this functionality out of the box, so the extra permissions need to be set here.</p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">iamRoleStatements</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
    <span class="na">Action</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">SNS:Publish</span>
    <span class="na">Resource</span><span class="pi">:</span> <span class="s">${self:custom.snsTopicArn}</span>
  <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
    <span class="na">Action</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">SQS:SendMessage</span>
    <span class="na">Resource</span><span class="pi">:</span> <span class="s">${self:custom.sqsToshlDLQArn}</span></code></pre></figure>


<p>We are adding <code>SNS:Publish</code> permissions to the AWS resource with the Arn <code>${self:custom.snsTopicArn}</code>, and SQS:SendMessage permissions to the AWS resource with Arn <code>${self:custom.sqsToshlDLQArn}</code>. Again, the resource Arns are not being hardcoded, but are references to another part of the yml file, which are configured under the <code>custom</code> key. Let's have a look at them.</p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">custom</span><span class="pi">:</span>
  <span class="na">environment</span><span class="pi">:</span> <span class="s">${file(env.yml)}</span>
  <span class="na">customDomain</span><span class="pi">:</span>
    <span class="na">domainName</span><span class="pi">:</span> <span class="s">${self:custom.environment.domainName}</span>
    <span class="na">basePath</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">stage</span><span class="pi">:</span> <span class="s">${self:provider.stage}</span>
    <span class="na">createRoute53Record</span><span class="pi">:</span> <span class="no">true</span>

  <span class="c1"># SNS/SQS configuration</span>
  <span class="na">snsTopic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${self:service}-${self:provider.stage}-expense-created"</span>
  <span class="na">snsTopicArn</span><span class="pi">:</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Fn::Join"</span> <span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">,</span> <span class="pi">[</span><span class="s2">"</span><span class="s">arn:aws:sns:${self:provider.region}:"</span><span class="pi">,</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Ref"</span> <span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::AccountId"</span> <span class="pi">},</span> <span class="s2">"</span><span class="s">:${self:custom.snsTopic}"</span> <span class="pi">]</span> <span class="pi">]</span>  <span class="pi">}</span>
  <span class="na">sqsToshlDLQ</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${self:custom.snsTopic}-toshl-dlq"</span>
  <span class="na">sqsToshlDLQArn</span><span class="pi">:</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Fn::Join"</span> <span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">,</span> <span class="pi">[</span><span class="s2">"</span><span class="s">arn:aws:sqs:${self:provider.region}:"</span><span class="pi">,</span> <span class="pi">{</span> <span class="s2">"</span><span class="s">Ref"</span> <span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::AccountId"</span> <span class="pi">},</span> <span class="s2">"</span><span class="s">:${self:custom.sqsToshlDLQ}"</span> <span class="pi">]</span> <span class="pi">]</span>  <span class="pi">}</span></code></pre></figure>


<p>We've covered the <code>environment</code> bit before, so we're going to skip it. We'll also skip the <code>customDomain</code> bit as it's out of the scope of this post, but you can use that alongside the plugin <code>serverless-domain-manager</code> to point your own domain to the API Gateway endpoint. The lines below are where we can configure our own variables to be used somewhere else. For our use case we need two variables: an SNS topic and an SQS queue. With <code>snsTopic</code> and <code>sqlToshlDLQ</code> we set human readable names by interpolating a few other variables. In this case the values would end up being <code>expenses-dev-expense-created</code> and <code>expenses-dev-expense-created-toshl-dlq</code>. We then use these human readable values to figure out what the AWS Arn will be, by using some of the provided AWS CloudFormation functions like <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-join.html"><code>Fn::Join</code></a> (to join a list of values with a delimiter) or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html"><code>Ref</code></a> (to get references to existing AWS resources). We use <code>Ref</code> to get access to our AWS Account ID, as it's required to build the Arn string, and it's a value AWS has access to through the credentials we use to execute serverless. So, if your account ID was <code>1234</code>, the <code>snsTopicArn</code> would end up having the value <code>arn:aws:sns:us-east-1:1234:expenses-dev-expense-created</code>.</p>

<p>Let's move to the <code>package</code> key now, where the packaging of our code happens. In here we can decide what files to include and exclude in our package. Serverless will create a zip file when run, and upload it to an S3 bucket, where AWS Lambda will go to find out what to execute when certain lambdas are triggered.</p>

<p>In order to understand the <code>exclude</code> and <code>include</code> parameters, we need to look at our <code>Makefile</code> first:</p>


<figure class="highlight"><pre><code class="language-make" data-lang="make"><span class="nv">GOPACKAGES</span> <span class="o">=</span> <span class="nf">$(</span><span class="nb">shell</span> go list ./...  | <span class="nb">grep</span> <span class="nt">-v</span> /vendor/<span class="nf">)</span>

<span class="nl">build</span><span class="o">:</span>
    <span class="err">dep</span> <span class="err">ensure</span> <span class="err">-v</span>
    <span class="err">env</span> <span class="nv">GOOS</span><span class="o">=</span>linux go build <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-s -w"</span> <span class="nt">-o</span> bin/monzo monzo/main.go
    <span class="err">env</span> <span class="nv">GOOS</span><span class="o">=</span>linux go build <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-s -w"</span> <span class="nt">-o</span> bin/toshl toshl/main.go

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">clean</span>
<span class="nl">clean</span><span class="o">:</span>
    <span class="err">rm</span> <span class="err">-rf</span> <span class="err">./bin</span> <span class="err">./vendor</span> <span class="err">Gopkg.lock</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">deploy</span>
<span class="nl">deploy</span><span class="o">:</span> <span class="nf">clean build</span>
    <span class="err">sls</span> <span class="err">deploy</span> <span class="err">--verbose</span>

<span class="nl">silent_deploy</span><span class="o">:</span> <span class="nf">clean build</span>
    <span class="err">sls</span> <span class="err">deploy</span> <span class="err">&gt;</span> <span class="err">/dev/null</span> <span class="err">2&gt;&amp;1</span>

<span class="nl">test</span><span class="o">:</span>
<span class="err">@go</span> <span class="err">test</span> <span class="err">-v</span> <span class="err">$(GOPACKAGES)</span></code></pre></figure>


<p>When building our go binaries, we will output them into the <code>./bin</code> folder. The <code>monzo</code> lambda will go to <code>./bin/monzo</code> and the <code>toshl</code> lambda will go to <code>./bin/toshl</code>.</p>

<p>This means that what we really want to package and upload to S3 is the <code>./bin</code> folder only. By excluding <code>./**</code> we exclude from packaging essentially everything except what's on the inclusion list, and so by then including <code>./bin/**</code> we are effectively only packaging the <code>./bin</code> folder which is exactly what we need.</p>

<p>The <code>functions</code> key is the one that actually sets the serverless artifacts for us. It has two keys, <code>monzo</code> and <code>toshl</code>, as we have 2 lambdas.</p>

<h2>The monzo lambda</h2>

<p>The <code>monzo</code> lambda has one job: process an incoming Monzo transaction request, filter it if we are interested in it, and then publish a message to an SNS topic with the information of the expense we want to record. The definition of the function in serverless is quite straightforward:</p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">monzo</span><span class="pi">:</span>
  <span class="na">handler</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bin/monzo"</span>
  <span class="na">events</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api/v1/create"</span>
        <span class="na">method</span><span class="pi">:</span> <span class="s2">"</span><span class="s">post"</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">snsTopicArn</span><span class="pi">:</span> <span class="s">${self:custom.snsTopicArn}</span>
    <span class="na">categoryData</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/CategoryData}</span></code></pre></figure>


<p>We tell AWS lambda that the binary in <code>bin/monzo</code> should be the one handling the request through the <code>handler</code> key. In <code>events</code> we tell API Gateway to map <code>POST</code> requests to the URL <code>api/v1/create</code> to the lambda. Finally, via the <code>environment</code> block, we pass two environment variables to the running process or handler: <code>snsTopicArn</code> and <code>categoryData</code>. <code>snsTopicArn</code> is the SNS topic where we want to publish messages, and the <code>categoryData</code> is a JSON string with information that will let us filter the transactions we are interested in. We get the SNS topic from a variable set up in the same <code>serverless.yml</code> file, and the category data we get from AWS Parameter Store, more specifically from the key <code>expenses/CategoryData</code>. You will have to manually populate this to your needs. For example, if you're only interested in transactions labelled as <code>entertainment</code>, and map them to a Toshl category named <code>Entertainment</code>, the string will look like this: <code>{"entertainment":"Entertainment"}</code></p>

<p>To summarise, whenever a <code>POST</code> request is made to the <code>api/v1/create</code> URL, API Gateway will work its magic, transform that request into a suitable object, and invoke the executable in <code>bin/monzo</code>, also providing the necessary environment variables as a way to configure our lambda.</p>

<p>Let's have a look at the Go code that will execute as a lambda:</p>


<figure class="highlight"><figcaption>monzo/main.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"encoding/json"</span>
    <span class="s">"os"</span>

    <span class="s">"github.com/aws/aws-lambda-go/lambda"</span>
    <span class="s">"github.com/aws/aws-sdk-go/aws/session"</span>
    <span class="s">"github.com/aws/aws-sdk-go/service/sns"</span>
    <span class="s">"github.com/brafales/expenses/monzo/handler"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">categories</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">getCategories</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">h</span> <span class="o">:=</span> <span class="n">handler</span><span class="o">.</span><span class="n">Handler</span><span class="p">{</span>
        <span class="n">SnsTopicArn</span><span class="o">:</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"snsTopicArn"</span><span class="p">),</span>
        <span class="n">Categories</span><span class="o">:</span>  <span class="n">categories</span><span class="p">,</span>
        <span class="n">SNSClient</span><span class="o">:</span>   <span class="n">sns</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">New</span><span class="p">()),</span>
    <span class="p">}</span>
    <span class="n">lambda</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Handle</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getCategories</span><span class="p">()</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rawData</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"categoryData"</span><span class="p">)</span>
    <span class="k">var</span> <span class="n">categoryMap</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">rawData</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">categoryMap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="n">categories</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">categoryMap</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">categoryMap</span> <span class="p">{</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">categories</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>


<p>AWS provides a <a href="https://docs.aws.amazon.com/lambda/latest/dg/go-programming-model-handler-types.html">Lambda SDK for Go</a>. The lambda is a Go binary that needs to define a main function, and that main function needs to eventually call a lambda handler function. The signature of the lambda handler function depends on the type of event we are handling. In our case we are handling an API Gateway event, and so our handler looks like this:</p>


<figure class="highlight"><figcaption>monzo/hanler/handler.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">handler</span>
<span class="k">package</span> <span class="n">handler</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="s">"encoding/json"</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/aws/aws-lambda-go/events"</span>
	<span class="s">"github.com/aws/aws-sdk-go/aws"</span>
	<span class="s">"github.com/aws/aws-sdk-go/service/sns"</span>
	<span class="s">"github.com/aws/aws-sdk-go/service/sns/snsiface"</span>
<span class="p">)</span>

<span class="c">// Response is of type APIGatewayProxyResponse since we're leveraging the</span>
<span class="c">// AWS Lambda Proxy Request functionality (default behavior)</span>
<span class="c">//</span>
<span class="c">// https://www.serverless.com/framework/docs/providers/aws/events/apigateway/#lambda-proxy-integration</span>
<span class="k">type</span> <span class="n">Response</span> <span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyResponse</span>

<span class="c">// {</span>
<span class="c">//     "type": "transaction.created",</span>
<span class="c">//     "data": {</span>
<span class="c">//         "account_id": "acc_00008gju41AHyfLUzBUk8A",</span>
<span class="c">//         "amount": -350,</span>
<span class="c">//         "created": "2015-09-04T14:28:40Z",</span>
<span class="c">//         "currency": "GBP",</span>
<span class="c">//         "description": "Ozone Coffee Roasters",</span>
<span class="c">//         "id": "tx_00008zjky19HyFLAzlUk7t",</span>
<span class="c">//         "category": "eating_out",</span>
<span class="c">//         "is_load": false,</span>
<span class="c">//         "settled": true,</span>
<span class="c">//         "merchant": {</span>
<span class="c">//             "address": {</span>
<span class="c">//                 "address": "98 Southgate Road",</span>
<span class="c">//                 "city": "London",</span>
<span class="c">//                 "country": "GB",</span>
<span class="c">//                 "latitude": 51.54151,</span>
<span class="c">//                 "longitude": -0.08482400000002599,</span>
<span class="c">//                 "postcode": "N1 3JD",</span>
<span class="c">//                 "region": "Greater London"</span>
<span class="c">//             },</span>
<span class="c">//             "created": "2015-08-22T12:20:18Z",</span>
<span class="c">//             "group_id": "grp_00008zIcpbBOaAr7TTP3sv",</span>
<span class="c">//             "id": "merch_00008zIcpbAKe8shBxXUtl",</span>
<span class="c">//             "logo": "https://pbs.twimg.com/profile_images/527043602623389696/68_SgUWJ.jpeg",</span>
<span class="c">//             "emoji": "üçû",</span>
<span class="c">//             "name": "The De Beauvoir Deli Co.",</span>
<span class="c">//             "category": "eating_out"</span>
<span class="c">//         }</span>
<span class="c">//     }</span>
<span class="c">// }</span>
<span class="k">type</span> <span class="n">monzoEvent</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Type</span> <span class="kt">string</span> <span class="s">`json:"type"`</span>
	<span class="n">Data</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">AccountID</span>   <span class="kt">string</span>    <span class="s">`json:"account_id"`</span>
		<span class="n">Amount</span>      <span class="kt">int</span>       <span class="s">`json:"amount"`</span>
		<span class="n">Created</span>     <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="s">`json:"created"`</span>
		<span class="n">Currency</span>    <span class="kt">string</span>    <span class="s">`json:"currency"`</span>
		<span class="n">Description</span> <span class="kt">string</span>    <span class="s">`json:"description"`</span>
		<span class="n">ID</span>          <span class="kt">string</span>    <span class="s">`json:"id"`</span>
		<span class="n">Category</span>    <span class="kt">string</span>    <span class="s">`json:"category"`</span>
		<span class="n">IsLoad</span>      <span class="kt">bool</span>      <span class="s">`json:"is_load"`</span>
		<span class="n">Merchant</span>    <span class="k">struct</span> <span class="p">{</span>
			<span class="n">Address</span> <span class="k">struct</span> <span class="p">{</span>
				<span class="n">Address</span>   <span class="kt">string</span>  <span class="s">`json:"address"`</span>
				<span class="n">City</span>      <span class="kt">string</span>  <span class="s">`json:"city"`</span>
				<span class="n">Country</span>   <span class="kt">string</span>  <span class="s">`json:"country"`</span>
				<span class="n">Latitude</span>  <span class="kt">float64</span> <span class="s">`json:"latitude"`</span>
				<span class="n">Longitude</span> <span class="kt">float64</span> <span class="s">`json:"longitude"`</span>
				<span class="n">Postcode</span>  <span class="kt">string</span>  <span class="s">`json:"postcode"`</span>
				<span class="n">Region</span>    <span class="kt">string</span>  <span class="s">`json:"region"`</span>
			<span class="p">}</span> <span class="s">`json:"address"`</span>
			<span class="n">Created</span>  <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="s">`json:"created"`</span>
			<span class="n">GroupID</span>  <span class="kt">string</span>    <span class="s">`json:"group_id"`</span>
			<span class="n">ID</span>       <span class="kt">string</span>    <span class="s">`json:"id"`</span>
			<span class="n">Logo</span>     <span class="kt">string</span>    <span class="s">`json:"logo"`</span>
			<span class="n">Emoji</span>    <span class="kt">string</span>    <span class="s">`json:"emoji"`</span>
			<span class="n">Name</span>     <span class="kt">string</span>    <span class="s">`json:"name"`</span>
			<span class="n">Category</span> <span class="kt">string</span>    <span class="s">`json:"category"`</span>
		<span class="p">}</span> <span class="s">`json:"merchant"`</span>
	<span class="p">}</span> <span class="s">`json:"data"`</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">expenseEvent</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Amount</span>      <span class="kt">int</span>       <span class="s">`json:"amount"`</span>
	<span class="n">Created</span>     <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="s">`json:"created"`</span>
	<span class="n">Currency</span>    <span class="kt">string</span>    <span class="s">`json:"currency"`</span>
	<span class="n">Description</span> <span class="kt">string</span>    <span class="s">`json:"description"`</span>
	<span class="n">Category</span>    <span class="kt">string</span>    <span class="s">`json:"category"`</span>
<span class="p">}</span>

<span class="c">// Handler is a type that will handle a Monzo request coming through an API Gateway Proxy Request</span>
<span class="k">type</span> <span class="n">Handler</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">SnsTopicArn</span> <span class="kt">string</span>
	<span class="n">Categories</span>  <span class="p">[]</span><span class="kt">string</span>
	<span class="n">SNSClient</span>   <span class="n">snsiface</span><span class="o">.</span><span class="n">SNSAPI</span>
<span class="p">}</span>

<span class="c">// Handle handles a Monzo request coming through an API Gateway Proxy Request</span>
<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span><span class="n">Handler</span><span class="p">)</span> <span class="n">Handle</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">request</span> <span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyRequest</span><span class="p">)</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">event</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">monzoEvent</span><span class="p">{}</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">Body</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyResponse</span><span class="p">{</span><span class="n">Body</span><span class="o">:</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">(),</span> <span class="n">StatusCode</span><span class="o">:</span> <span class="m">500</span><span class="p">},</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">interested</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">:=</span> <span class="n">h</span><span class="o">.</span><span class="n">publishEvent</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyResponse</span><span class="p">{</span><span class="n">Body</span><span class="o">:</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">(),</span> <span class="n">StatusCode</span><span class="o">:</span> <span class="m">500</span><span class="p">},</span> <span class="n">err</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyResponse</span><span class="p">{</span><span class="n">Body</span><span class="o">:</span> <span class="s">"OK"</span><span class="p">,</span> <span class="n">StatusCode</span><span class="o">:</span> <span class="m">200</span><span class="p">},</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span><span class="n">Handler</span><span class="p">)</span> <span class="n">publishEvent</span><span class="p">(</span><span class="n">event</span> <span class="n">monzoEvent</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">expense</span> <span class="o">:=</span> <span class="n">expenseEvent</span><span class="p">{</span>
		<span class="n">Amount</span><span class="o">:</span>      <span class="n">event</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Amount</span><span class="p">,</span>
		<span class="n">Created</span><span class="o">:</span>     <span class="n">event</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Created</span><span class="p">,</span>
		<span class="n">Description</span><span class="o">:</span> <span class="n">event</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span>
		<span class="n">Category</span><span class="o">:</span>    <span class="n">event</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Category</span><span class="p">,</span>
		<span class="n">Currency</span><span class="o">:</span>    <span class="n">event</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Currency</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">expenseBytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">expense</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">sns</span><span class="o">.</span><span class="n">PublishInput</span><span class="p">{</span>
		<span class="n">Message</span><span class="o">:</span>  <span class="n">aws</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">expenseBytes</span><span class="p">)),</span>
		<span class="n">TopicArn</span><span class="o">:</span> <span class="n">aws</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">SnsTopicArn</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">SNSClient</span><span class="o">.</span><span class="n">Publish</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span><span class="n">Handler</span><span class="p">)</span> <span class="n">interested</span><span class="p">(</span><span class="n">event</span> <span class="n">monzoEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">h</span><span class="o">.</span><span class="n">Categories</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Category</span> <span class="p">{</span>
			<span class="k">return</span> <span class="no">true</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">false</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>


<p>Let's quickly go through the code to understand what it does. The main function starts by reading the <code>categoryData</code> environment variable (which AWS will set up for us) and fills a string array with it, which will contain the list of transaction categories we are interested in.</p>

<p>After this, it instantiates a new handler, passing in some configuration options (the SNS topic, the list of categories we just retrieved and an SNS client to talk to SNS), and uses this handler's <code>Handle</code> function as an argument of <code>lambda.Start</code>.</p>

<p>Once in the handler, we get the API Gateway request body and unmarshal it into our own struct type <code>monzoEvent</code>. We check if the category of the monzo event is in the list of categories we care about, and if that's the case, we build an <code>expenseEvent</code> payload with the information we require, and we publish an SNS message.</p>

<p>If all goes well, our handler returns the <code>return events.APIGatewayProxyResponse{Body: "OK", StatusCode: 200}, nil</code> tuple. The AWS Lambda SDK will interpret that as a success and return the appropriate 200 HTTP response code back. If something fails, we let the <code>Handle</code> method return an error and an appropriate response code (in our case it'd be a 500 error), with the error string as the body.</p>

<h2>The toshl lambda</h2>

<p>The <code>toshl</code> lambda works the opposite way: picks up a message from an SNS topic, and as a result ends up making an HTTP request to the Toshl API.</p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">toshl</span><span class="pi">:</span>
  <span class="na">handler</span><span class="pi">:</span> <span class="s">bin/toshl</span>
  <span class="na">events</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">sns</span><span class="pi">:</span> <span class="s">${self:custom.snsTopic}</span>
  <span class="na">deadLetter</span><span class="pi">:</span>
    <span class="na">sqs</span><span class="pi">:</span> <span class="s">${self:custom.sqsToshlDLQ}</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">snsTopicArn</span><span class="pi">:</span> <span class="s">${self:custom.snsTopicArn}</span>
    <span class="na">token</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/ToshlToken~true}</span>
    <span class="na">accountId</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/ToshlAccountId}</span>
    <span class="na">categoryData</span><span class="pi">:</span> <span class="s">${ssm:/${self:service}/CategoryData}</span></code></pre></figure>


<p>In our serverless config, we link the event to the SNS topic we have configured. This will instruct AWS to create a subscription to the SNS topic piped to our lambda. We also configure a <code>deadLetter</code> parameter. This comes from the plugin <code>serverless-plugin-lambda-dead-letter</code> and allows us to use the Dead Letter Queue pattern for our lambda. The way the Dead Letter Queue will work is as follows:
<ul>
<li>A message is sent to the SNS topic, and processed by the lambda.</li>
<li>If the lambda fails to process the message by returning an error code, AWS will retry a few times, applying <a href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a> between retries.</li>
<li>If the lambda fails to process the message after all retries, the message will get queued in the configured Dead Letter Queue. We can then inspect the failed messages in that queue for analysis if we need to. This way we ensure that we never lose important information, and that we can always replay those events if they were caused by a bug in our software or by a transient error (e.g. Toshl had an outage).</li>
</ul>
</p>

<p>This is what the Go code looks like for the lambda itself:</p>


<figure class="highlight"><figcaption>toshl/main.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"context"</span>
    <span class="s">"encoding/json"</span>
    <span class="s">"net/http"</span>
    <span class="s">"os"</span>

    <span class="s">"github.com/aws/aws-lambda-go/events"</span>
    <span class="s">"github.com/aws/aws-lambda-go/lambda"</span>
    <span class="s">"github.com/brafales/expenses/toshl/client"</span>
<span class="p">)</span>

<span class="c">// Handler will handle the lambda function</span>
<span class="k">func</span> <span class="n">Handler</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">snsEvent</span> <span class="n">events</span><span class="o">.</span><span class="n">SNSEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">categories</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">categories</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">toshlClient</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span>
        <span class="n">AuthToken</span><span class="o">:</span>    <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"token"</span><span class="p">),</span>
        <span class="n">AccountID</span><span class="o">:</span>    <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"accountId"</span><span class="p">),</span>
        <span class="n">HTTPClient</span><span class="o">:</span>   <span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{},</span>
        <span class="n">CategoryMap</span><span class="o">:</span>  <span class="n">categories</span><span class="p">,</span>
        <span class="n">ToshlBaseURL</span><span class="o">:</span> <span class="s">"https://api.toshl.com"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">snsEvent</span><span class="o">.</span><span class="n">Records</span> <span class="p">{</span>
        <span class="n">snsRecord</span> <span class="o">:=</span> <span class="n">record</span><span class="o">.</span><span class="n">SNS</span>

        <span class="n">expense</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">createExpense</span><span class="p">(</span><span class="n">snsRecord</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">toshlClient</span><span class="o">.</span><span class="n">CreateEntry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expense</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">lambda</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">Handler</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">categories</span><span class="p">()</span> <span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rawData</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"categoryData"</span><span class="p">)</span>
    <span class="k">var</span> <span class="n">categoryMap</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">rawData</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">categoryMap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{},</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">categoryMap</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">createExpense</span><span class="p">(</span><span class="n">message</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">Expense</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">expense</span> <span class="n">client</span><span class="o">.</span><span class="n">Expense</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">expense</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expense</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>



<figure class="highlight"><figcaption>toshl/client/client.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">client</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"bytes"</span>
    <span class="s">"encoding/json"</span>
    <span class="s">"fmt"</span>
    <span class="s">"net/http"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="c">// Client is a client to talk to Toshl's REST API</span>
<span class="k">type</span> <span class="n">Client</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">AuthToken</span>    <span class="kt">string</span>
    <span class="n">AccountID</span>    <span class="kt">string</span>
    <span class="n">HTTPClient</span>   <span class="n">http</span><span class="o">.</span><span class="n">Client</span>
    <span class="n">CategoryMap</span>  <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
    <span class="n">ToshlBaseURL</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c">// Expense defines a Toshl Entry</span>
<span class="k">type</span> <span class="n">Expense</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Amount</span>      <span class="kt">int</span>       <span class="s">`json:"amount"`</span>
    <span class="n">Created</span>     <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="s">`json:"created"`</span>
    <span class="n">Currency</span>    <span class="kt">string</span>    <span class="s">`json:"currency"`</span>
    <span class="n">Description</span> <span class="kt">string</span>    <span class="s">`json:"description"`</span>
    <span class="n">Category</span>    <span class="kt">string</span>    <span class="s">`json:"category"`</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">toshlCurrency</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Code</span> <span class="kt">string</span> <span class="s">`json:"code"`</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">toshlEntry</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Amount</span>   <span class="kt">float64</span>       <span class="s">`json:"amount"`</span>
    <span class="n">Currency</span> <span class="n">toshlCurrency</span> <span class="s">`json:"currency"`</span>
    <span class="n">Date</span>     <span class="kt">string</span>        <span class="s">`json:"date"`</span>
    <span class="n">Desc</span>     <span class="kt">string</span>        <span class="s">`json:"desc"`</span>
    <span class="n">Account</span>  <span class="kt">string</span>        <span class="s">`json:"account"`</span>
    <span class="n">Category</span> <span class="kt">string</span>        <span class="s">`json:"category"`</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">toshlCategory</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ID</span>   <span class="kt">string</span> <span class="s">`json:"id"`</span>
    <span class="n">Name</span> <span class="kt">string</span> <span class="s">`json:"name"`</span>
<span class="p">}</span>

<span class="c">// CreateEntry entry will create a new entry in Toshl based on the Expense data</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">CreateEntry</span><span class="p">(</span><span class="n">expense</span> <span class="o">*</span><span class="n">Expense</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">newToshlEntry</span><span class="p">(</span><span class="n">expense</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="n">dataJSON</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="n">req</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"POST"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s/entries"</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">ToshlBaseURL</span><span class="p">),</span> <span class="n">bytes</span><span class="o">.</span><span class="n">NewBuffer</span><span class="p">(</span><span class="n">dataJSON</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="n">req</span><span class="o">.</span><span class="n">SetBasicAuth</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">AuthToken</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">HTTPClient</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">respCode</span> <span class="o">:=</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span>
    <span class="k">if</span> <span class="n">respCode</span> <span class="o">!=</span> <span class="m">201</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Something went wrong, response code was %d"</span><span class="p">,</span> <span class="n">respCode</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">newToshlEntry</span><span class="p">(</span><span class="n">expense</span> <span class="o">*</span><span class="n">Expense</span><span class="p">)</span> <span class="p">(</span><span class="n">toshlEntry</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">category</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">categoryID</span><span class="p">(</span><span class="n">expense</span><span class="o">.</span><span class="n">Category</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">toshlEntry</span><span class="p">{},</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="n">entry</span> <span class="o">:=</span> <span class="n">toshlEntry</span><span class="p">{</span>
        <span class="n">Amount</span><span class="o">:</span> <span class="kt">float64</span><span class="p">(</span><span class="n">expense</span><span class="o">.</span><span class="n">Amount</span><span class="p">)</span> <span class="o">/</span> <span class="m">100</span><span class="p">,</span>
        <span class="n">Currency</span><span class="o">:</span> <span class="n">toshlCurrency</span><span class="p">{</span>
            <span class="n">Code</span><span class="o">:</span> <span class="n">expense</span><span class="o">.</span><span class="n">Currency</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">Date</span><span class="o">:</span>     <span class="n">expense</span><span class="o">.</span><span class="n">Created</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"2006-01-02"</span><span class="p">),</span>
        <span class="n">Desc</span><span class="o">:</span>     <span class="n">expense</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span>
        <span class="n">Account</span><span class="o">:</span>  <span class="n">c</span><span class="o">.</span><span class="n">AccountID</span><span class="p">,</span>
        <span class="n">Category</span><span class="o">:</span> <span class="n">category</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">entry</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">categoryID</span><span class="p">(</span><span class="n">categoryName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mappedCategoryName</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">CategoryMap</span><span class="p">[</span><span class="n">categoryName</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mappedCategoryName</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Category %s not in the mapping"</span><span class="p">,</span> <span class="n">categoryName</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s/categories"</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">ToshlBaseURL</span><span class="p">),</span> <span class="no">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="n">req</span><span class="o">.</span><span class="n">SetBasicAuth</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">AuthToken</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">HTTPClient</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="k">var</span> <span class="n">categories</span> <span class="p">[]</span><span class="n">toshlCategory</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">categories</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="n">category</span> <span class="kt">string</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">categories</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">Name</span> <span class="o">==</span> <span class="n">mappedCategoryName</span> <span class="p">{</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">ID</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Category not found in Toshl for name %s"</span><span class="p">,</span> <span class="n">mappedCategoryName</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">category</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>


<p>In the main entry point we call a handling function. This handler function will do a few things:</p>

<ul>
<li>It'll read the <code>categoryData</code> environment variable to build a category mapping. This will allow us to map incoming expenses categories into Toshl categories.</li>
<li>It'll then create an instance of a client struct, which we will use to communicate with Toshl. For this client, we need some other secrets we read from environment variables too.</li>
<li>Finally, it'll loop through the records in the SNS event, and will process them by mapping them into an expense and then telling the Toshl client to create an entry. An SNS event can have multiple records, if a few messages have been published to the topic in quick succession.</li>
</ul>

<p>The Toshl client struct is a pretty straightforward Go HTTP client talking to a REST JSON API.</p>

<h2>Putting it all together</h2>

<p>Assuming you have <a href="https://www.serverless.com/framework/docs/providers/aws/guide/intro/">set up your serverless account properly and have configured your AWS credentials</a>, you are ready to go. Check out the code, and in the root folder, type in <code>make deploy</code>, and you're good to go. This is what should typically happen:</p>
<ol>
<li>The binaries for your two lambdas will be built in the <code>./bin</code> folder.</li>
<li>serverless will then package your binaries in a zip file and upload them into an S3 bucket.</li>
<li>serverless will then start creating all the AWS artifacts: the API Gateway, the 2 lambdas, an SNS topic, an SQS queue, all the subscriptions between SNS topics, SQS queues, API Gateway requests and Lambdas.</li>
</ol>

<p>As an output, and assuming everything went ok, you'll get a URL. This is the URL of your API Gateway endpoint. You can then pick that up and make a call to the Monzo API so their webhooks point at that same URL. After that, your Monzo expenses will be linked and will magically appear in Toshl.</p>
</p>

  </div>

</article>

<div class="pagination">

  <a class="previous" href="/2018/08/25/walk-through-flang-part-7/">&laquo; Walk-through flang ‚Äì Part 7</a>


  <a class="next" href="/2018/12/22/walk-through-flang-part-8/">Walk-through flang ‚Äì Part 8 &raquo;</a>

</div>



      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Powered by <a href="https://jekyllrb.com">Jekyll</a>. Theme based on <a href="https://github.com/yous/whiteglass">whiteglass</a>
<br>
Subscribe via <a href="https://thinkingeek.com/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
