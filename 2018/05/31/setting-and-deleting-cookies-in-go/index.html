<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Setting and deleting cookies in Go</title>
  <meta name="description" content="In this post we&#39;ll learn how to set and delete cookies as part of your Go HTTP Handlers. We&#39;ll also learn one way to test our handlers using HTTP recorders.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://thinkingeek.com/2018/05/31/setting-and-deleting-cookies-in-go/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Think In Geek" href="https://thinkingeek.com/feed.xml">

  

  
  <meta property="og:title" content="Setting and deleting cookies in Go">
  <meta property="og:site_name" content="Think In Geek">
  <meta property="og:url" content="https://thinkingeek.com/2018/05/31/setting-and-deleting-cookies-in-go/">
  <meta property="og:description" content="In this post we&#39;ll learn how to set and delete cookies as part of your Go HTTP Handlers. We&#39;ll also learn one way to test our handlers using HTTP recorders.">
  
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Setting and deleting cookies in Go">
  <meta name="twitter:description" content="In this post we&#39;ll learn how to set and delete cookies as part of your Go HTTP Handlers. We&#39;ll also learn one way to test our handlers using HTTP recorders.">
  
  

  <link rel="stylesheet" href="/assets/fonts/fonts.css">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

      <span class="site-title"><a href="/">Think In Geek</a> | </span>
      <span class="site-slogan">In geek we trust</span>

    <nav class="site-nav"><a class="page-link" href="/series/">Series</a><a class="page-link" href="/author/brafales/">Posts by Bernat Ràfales</a><a class="page-link" href="/archives/">Archives</a></nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Setting and deleting cookies in Go</h1>
    
    <p class="post-meta"><time datetime="2018-05-31T09:51:23+00:00" itemprop="datePublished">May 31, 2018</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span> • <a href="/categories/uncategorized/">Uncategorized</a> • <a href="/tags/go/">go</a>, <a href="/tags/testing/">testing</a></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>
In this post we'll learn how to set and delete cookies as part of your Go HTTP Handlers. We'll also learn one way to test our handlers using HTTP recorders.
</p>
<!--more-->

<h2>The Project</h2>
<p>We will simulate a very basic web application where users can log in and log out. The login mechanism will be by setting a cookie to a particular value. It’s important to note than while using a cookie to store a user’s session is a common pattern, in this particular case we will be doing it in a very unsafe way: the cookie will not be encrypted or secured in any way other than having the <code>httpOnly</code> flag on and therefore it could be quite easy for an attacker to pretend to be logged in on the site by tampering it.</p>

<p>Our simple requirements will be as follows:</p>
<ul>
	<li>When a users goes to the <code>/login</code> page of our website, a cookie should be set with the name <code>session</code>, a value of <code>logged in</code>, and an expiry time of an hour</li>
	<li>When a users goes to the <code>/logout</code> page of our website, the above cookie should be deleted</li>
</ul>

<h2>The code</h2>
<p>As it’s usual for Go web servers, we will have 2 handlers: one for the login route and one for the logout route. Our project is going to look like this:</p>
<ul>
	<li>In the root of the project we'll have our <code>main.go</code> file that will serve as the main entry point</li>
	<li>In a folder called handlers we will have the 2 handlers we need, and the tests for them: <code>login.go</code>, <code>login_test.go</code>, <code>logout.go</code> and <code>logout_test.go</code></li>
</ul>

<p>From now on we’ll assume the code is going to be hosted at github, under this path: <a href="https://github.com/brafales/go-session" rel="noopener" target="_blank"><code>https://github.com/brafales/go-session</code></a>. You’ll see the usual go package dependencies referencing this path all over the examples.</p>

<p>In Go, <a href="https://golang.org/pkg/net/http/#Handler" rel="noopener" target="_blank"><code>http.Handler</code></a> is an interface type that responds to an HTTP request. In order for a type to comply with this interface, there’s only one method that needs implementing:</p>

<figure class="highlight"><figcaption>httpHandler.go</figcaption><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">Handler</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">ServeHTTP</span><span class="p">(</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="n">Request</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>The <a href="https://golang.org/pkg/net/http/#ResponseWriter" rel="noopener" target="_blank"><code>ResponseWriter</code></a> is the object we can use in our handler to actually return a response to the request. This is the object we will typically interact to return a body, a status code, headers or cookies. On the other hand, the <a href="https://golang.org/pkg/net/http/#Request" rel="noopener" target="_blank"><code>Request</code></a> object will hold all the information we need from the incoming request, in case we need some information from it that will have an effect on how we respond to it.</p>

<p>Let’s go ahead and create our login handler skeleton:</p>

<figure class="highlight"><figcaption>handlers/login.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">handlers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="c">// Login is a handler that sets a logged in cookie</span>
<span class="k">type</span> <span class="n">Login</span> <span class="k">struct</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="n">Login</span><span class="p">)</span> <span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>First we create our new type <code>Login</code> as a <code>struct</code>, and then give that type a method so it can implement the <code>http.Handler</code> interface. The method will do nothing for the time being. We create the type inside the <code>handlers</code> package, and we import the <code>net/http</code> package so we can reference types like <code>http.ResponseWriter</code> and <code>http.Request</code>.</p>

<p>Now that we have our handler ready to use, let’s have a look at our entry point to see how can we tie it to the main program. There are many ways to serve a certain route on an HTTP server by a handler. For this exercise we will just use Go’s basic building blocks from the <code>net/http</code> package: the <a href="https://golang.org/pkg/net/http/#Handle" rel="noopener" target="_blank"><code>http.Handle</code></a> and <a href="https://golang.org/pkg/net/http/#ListenAndServe" rel="noopener" target="_blank"><code>http.ListenAndServe</code></a> functions.</p>

<p>The <code>http.Handle</code> function has the following signature: <code>func Handle(pattern string, handler Handler)</code>. Quoting from the official documentation,</p>

<blockquote>Handle registers the handler for the given pattern in the DefaultServeMux. The documentation for ServeMux explains how patterns are matched.</blockquote>

<p>In its most simple form, we can use it like this: <code>http.Handle("/login", handlers.Login{})</code>. This will send any requests coming to the <code>/login</code> path to our newly created handler.</p>

<p>Then we have <code>http.ListenAndServe</code>: <code>func ListenAndServe(addr string, handler Handler) error</code>. Quoting from the official documentation,</p>

<blockquote>ListenAndServe listens on the TCP network address addr and then calls Serve with handler to handle requests on incoming connections. Accepted connections are configured to enable TCP keep-alives. Handler is typically nil, in which case the DefaultServeMux is used.</blockquote>

<p>Again, in its most simple form, we can use it like this:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>The lines above will start an HTTP server listening on the port <code>8080</code> on our default network interface. We pass <code>nil</code> as the second parameter because we are not interested in a default handler and we will be registering our own.</p>

<p>At this stage, we could have a very small program that could look like this:</p>

<figure class="highlight"><figcaption>main.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>

	<span class="s">"github.com/brafales/go-session/handlers"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">loginHandler</span> <span class="o">:=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">Login</span><span class="p">{}</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/login"</span><span class="p">,</span> <span class="n">loginHandler</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>If we compile and run this program, and point our browser to http://localhost:8080/login we should get a response with a status 200 and no body. Now that we have our skeleton ready, let’s go back to our handler and see how to set the actual cookie.</p>

<h2>Setting a cookie</h2>
<p>Let’s have a look at how we can set a cookie in our handler. There’s a handy method in the <code>net/http</code> package that will allow us do to exactly that: <a href="https://golang.org/pkg/net/http/#SetCookie" rel="noopener" target="_blank"><code>SetCookie</code></a>. Its signature is <code>func SetCookie(w ResponseWriter, cookie *Cookie)</code>. It takes an <code>http.ResponseWriter</code> and an <a href="https://golang.org/pkg/net/http/#Cookie" rel="noopener" target="_blank"><code>http.Cookie</code></a> pointer as parameters. As you may have guessed, we can use the handler’s <code>ResponseWriter</code> parameter, and we need to build our own cookie. The <code>http.Cookie</code> type is quite straightforward:</p>

<figure class="highlight"><figcaption>http.Cookie.go</figcaption><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">Cookie</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="n">Name</span>  <span class="kt">string</span>
        <span class="n">Value</span> <span class="kt">string</span>

        <span class="n">Path</span>       <span class="kt">string</span>    <span class="c">// optional</span>
        <span class="n">Domain</span>     <span class="kt">string</span>    <span class="c">// optional</span>
        <span class="n">Expires</span>    <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="c">// optional</span>
        <span class="n">RawExpires</span> <span class="kt">string</span>    <span class="c">// for reading cookies only</span>

        <span class="c">// MaxAge=0 means no 'Max-Age' attribute specified.</span>
        <span class="c">// MaxAge&lt;0 means delete cookie now, equivalently 'Max-Age: 0'</span>
        <span class="c">// MaxAge&gt;0 means Max-Age attribute present and given in seconds</span>
        <span class="n">MaxAge</span>   <span class="kt">int</span>
        <span class="n">Secure</span>   <span class="kt">bool</span>
        <span class="n">HttpOnly</span> <span class="kt">bool</span>
        <span class="n">Raw</span>      <span class="kt">string</span>
        <span class="n">Unparsed</span> <span class="p">[]</span><span class="kt">string</span> <span class="c">// Raw text of unparsed attribute-value pairs</span>
<span class="p">}</span></code></pre></figure>

<p>So for our purposes, our handler could look like this:</p>

<figure class="highlight"><figcaption>handlers/login.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">handlers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="c">// Login is a handler that sets a logged in cookie</span>
<span class="k">type</span> <span class="n">Login</span> <span class="k">struct</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="n">Login</span><span class="p">)</span> <span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cookie</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Cookie</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>     <span class="s">"session"</span><span class="p">,</span>
		<span class="n">Value</span><span class="o">:</span>    <span class="s">"logged in"</span><span class="p">,</span>
		<span class="n">Domain</span><span class="o">:</span>   <span class="s">"test.com"</span><span class="p">,</span>
		<span class="n">Path</span><span class="o">:</span>     <span class="s">"/"</span><span class="p">,</span>
		<span class="n">MaxAge</span><span class="o">:</span>   <span class="m">60</span> <span class="o">*</span> <span class="m">60</span><span class="p">,</span>
		<span class="n">HttpOnly</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">http</span><span class="o">.</span><span class="n">SetCookie</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Since we want our handlers to be a bit more flexible, we can make all of the cookie attributes part of the handler object. This will help us testing, and will let us eventually make changes in there quicker in the future. It’s also good practice to allow our handlers to be chained (so we can add a middleware type of functionality in our application like logging or monitoring). Let’s see what a complete login handler would look like with all these new features:</p>

<figure class="highlight"><figcaption>handlers/login.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">handlers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="c">// Login is a handler that sets a logged in cookie</span>
<span class="k">type</span> <span class="n">Login</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Name</span>   <span class="kt">string</span>
	<span class="n">Value</span>  <span class="kt">string</span>
	<span class="n">Path</span>   <span class="kt">string</span>
	<span class="n">Domain</span> <span class="kt">string</span>
	<span class="n">MaxAge</span> <span class="kt">int</span>
	<span class="n">Next</span>   <span class="n">http</span><span class="o">.</span><span class="n">Handler</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="n">Login</span><span class="p">)</span> <span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cookie</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Cookie</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>     <span class="n">l</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
		<span class="n">Value</span><span class="o">:</span>    <span class="n">l</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
		<span class="n">Domain</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">Domain</span><span class="p">,</span>
		<span class="n">Path</span><span class="o">:</span>     <span class="n">l</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
		<span class="n">MaxAge</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">MaxAge</span><span class="p">,</span>
		<span class="n">HttpOnly</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">http</span><span class="o">.</span><span class="n">SetCookie</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">)</span>
	<span class="n">l</span><span class="o">.</span><span class="n">Next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>With this new version of the code we can configure our handler as we please.</p>

<p>The logout handler will now be straightforward. Turns out the way to delete a cookie is essentially the same as setting it. The only difference is the <code>Max-Age</code> attribute is set to either <code>0</code> or a negative integer. With this in mind, we can write the handler as follows:</p>

<figure class="highlight"><figcaption>handlers/logout.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">handlers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="c">// Logout is a handler that clears a logged in cookie</span>
<span class="k">type</span> <span class="n">Logout</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Name</span>   <span class="kt">string</span>
	<span class="n">Path</span>   <span class="kt">string</span>
	<span class="n">Domain</span> <span class="kt">string</span>
	<span class="n">Next</span>   <span class="n">http</span><span class="o">.</span><span class="n">Handler</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="n">Logout</span><span class="p">)</span> <span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cookie</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Cookie</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>     <span class="n">l</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
		<span class="n">Value</span><span class="o">:</span>    <span class="s">""</span><span class="p">,</span>
		<span class="n">Domain</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">Domain</span><span class="p">,</span>
		<span class="n">Path</span><span class="o">:</span>     <span class="n">l</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
		<span class="n">MaxAge</span><span class="o">:</span>   <span class="m">0</span><span class="p">,</span>
		<span class="n">HttpOnly</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">http</span><span class="o">.</span><span class="n">SetCookie</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">)</span>
	<span class="n">l</span><span class="o">.</span><span class="n">Next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The only difference between the two handlers are two hard-coded values in the logout one: the <code>Max-Age</code> set to <code>0</code>, and the <code>Value</code> set to an empty string.</p>

<h2>Putting it all together</h2>
<p>Let’s get back to our main program now that we’ve got our handlers written an have a look at how can we tie it all together into a fully functional program. There are many ways to configure a Go application, in this exercise we’ll be keeping it simple and assume we can pass in configuration options to the application via environment variables. The <a href="https://golang.org/pkg/os" rel="noopener" target="_blank"><code>os</code></a> pakage from the standard library provides a function called <a href="https://golang.org/pkg/os/#Getenv" rel="noopener" target="_blank"><code>GetEnv</code></a> which allows us to read an variable from the environment: <code>func Getenv(key string) string</code>. What we need to do now is:</p>
<ol>
	<li>Get the configuration options from the environment</li>
	<li>Create a login and a logout handler with the configuration options</li>
	<li>Ensure requests to <code>/login</code> and <code>/logout</code> are served by the login and logout handlers respectively</li>
	<li>Start a new HTTP server that can start listening for requests</li>
</ol>

<p>Here’s what a complete example looks like:</p>

<figure class="highlight"><figcaption>main.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"net/http"</span>
	<span class="s">"os"</span>
	<span class="s">"strconv"</span>

	<span class="s">"github.com/brafales/go-session/handlers"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">cookieName</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"COOKIE_NAME"</span><span class="p">)</span>
	<span class="n">cookieValue</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"COOKIE_VALUE"</span><span class="p">)</span>
	<span class="n">cookieDomain</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"COOKIE_DOMAIN"</span><span class="p">)</span>
	<span class="n">cookiePath</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"COOKIE_PATH"</span><span class="p">)</span>
	<span class="n">cookieDuration</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"COOKIE_DURATION"</span><span class="p">)</span>

	<span class="n">cookieDurationInteger</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">cookieDuration</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">handler</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rw</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"OK"</span><span class="p">))</span>
	<span class="p">})</span>

	<span class="n">loginHandler</span> <span class="o">:=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">Login</span><span class="p">{</span><span class="n">Name</span><span class="o">:</span> <span class="n">cookieName</span><span class="p">,</span>
		<span class="n">Domain</span><span class="o">:</span> <span class="n">cookieDomain</span><span class="p">,</span>
		<span class="n">Path</span><span class="o">:</span>   <span class="n">cookiePath</span><span class="p">,</span>
		<span class="n">Value</span><span class="o">:</span>  <span class="n">cookieValue</span><span class="p">,</span>
		<span class="n">MaxAge</span><span class="o">:</span> <span class="n">cookieDurationInteger</span><span class="p">,</span>
		<span class="n">Next</span><span class="o">:</span>   <span class="n">handler</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">logoutHandler</span> <span class="o">:=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">Logout</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>   <span class="n">cookieName</span><span class="p">,</span>
		<span class="n">Domain</span><span class="o">:</span> <span class="n">cookieDomain</span><span class="p">,</span>
		<span class="n">Path</span><span class="o">:</span>   <span class="n">cookiePath</span><span class="p">,</span>
		<span class="n">Next</span><span class="o">:</span>   <span class="n">handler</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/login"</span><span class="p">,</span> <span class="n">loginHandler</span><span class="p">)</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/logout"</span><span class="p">,</span> <span class="n">logoutHandler</span><span class="p">)</span>

	<span class="n">address</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">":%s"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"PORT"</span><span class="p">))</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="no">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We get all the configuration options in lines 13 to 23. It’s worth mentioning that <code>strconv.Atoi</code> can error, and we will panic if we don’t get a proper integer supplied in the <code>COOKIE_DURATION</code> environment variable. On line 25 we create a generic handler that will write the string <code>"OK"</code> into an HTTP response. This is the handler that we will chain after our handlers, so requests to <code>/login</code> and <code>/logout</code> will both have <code>"OK"</code> in their response body. To create this handler, we’ve used the <a href="https://golang.org/pkg/net/http/#HandlerFunc" rel="noopener" target="_blank"><code>http.HandlerFunc</code></a> shortcut. This is an interesting and very idiomatic pattern in Go. <code>http.HandlerFunc</code> will take a function as a parameter. The function needs to have this signature: <code>func(ResponseWriter, *Request)</code>. This signature happens to be the same as the <code>ServeHTTP</code> one from the <code>http.Handler</code> interface. When calling <code>http.Handlerfunc</code> with a given function, you’ll get back an instance of a type that implements the <code>http.Handler</code> interface, so it’s ready for you to use without having to go through the hassle of creating a new type. Think about it as a way to create anonymous <code>http.Handler</code> objects.</p>

<p>In lines 29 to 42 we create the login and logout handlers. Then we proceed to map the <code>/login</code> and <code>/logout</code> paths to the handlers in lines 44 and 45, and finally we start a new HTTP server listening to a configured port in lines 47 to 51.</p>

<p>You can now compile and run the program like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$&gt;COOKIE_NAME</span><span class="o">=</span>session <span class="nv">COOKIE_VALUE</span><span class="o">=</span><span class="s2">"logged in"</span> <span class="nv">COOKIE_DOMAIN</span><span class="o">=</span><span class="s2">"test.com"</span> <span class="nv">COOKIE_PATH</span><span class="o">=</span><span class="s2">"/"</span> <span class="nv">COOKIE_DURATION</span><span class="o">=</span>60 <span class="nv">PORT</span><span class="o">=</span>8080 ./go-session</code></pre></figure>

<p>Point your favourite browser to <code>localhost:8080/login</code> and hopefully you should see your cookie set (you may need to trick your browser into thinking the <code>test.com</code> domain points to your <code>localhost</code> via the <code>/etc/hosts</code> file). Equally, after visiting <code>localhost:8080/logout</code>, you should see your cookie disappear.</p>

<h2>Testing our code</h2>
<p>One more thing… we need to write tests for our handlers!</p>

<p>Testing <code>http.Handler</code> types may seem daunting at first, but the Go standard library provides us with some great tools to make it easier, so we don’t have to waste too much time creating test HTTP requests and responses. One of these tools is the <a href="https://golang.org/pkg/net/http/httptest/#ResponseRecorder" rel="noopener" target="_blank"><code>ResponseRecorder</code></a> type from the <a href="https://golang.org/pkg/net/http/httptest" rel="noopener" target="_blank"><code>net/http/httptest</code></a> package. The <code>ReponseRecorder</code> type implements the <code>http.ResponseWriter</code> interface, so we can pass them as a parameter to <code>ServeHTTP</code>. Once we’ve called <code>ServeHTTP</code> against a <code>ResponseRecorder</code>, we can ask the recorder useful questions like what the response code was, what headers it sent back and, what matters to us, what cookies it set, if any.</p>

<p>This is what a possible test file for our login handler could look like:</p>

<figure class="highlight"><figcaption>handlers/login_test.go</figcaption><pre><code class="language-go" data-lang="go"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="code"><pre><span class="k">package</span> <span class="n">handlers_test</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"bytes"</span>
	<span class="s">"io/ioutil"</span>
	<span class="s">"net/http"</span>
	<span class="s">"net/http/httptest"</span>
	<span class="s">"testing"</span>

	<span class="s">"github.com/brafales/go-session/handlers"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestLogin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">expBody</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"test!"</span><span class="p">)</span>

	<span class="n">loginHandler</span> <span class="o">:=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">Login</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>   <span class="s">"session"</span><span class="p">,</span>
		<span class="n">Value</span><span class="o">:</span>  <span class="s">"logged in"</span><span class="p">,</span>
		<span class="n">Path</span><span class="o">:</span>   <span class="s">"/"</span><span class="p">,</span>
		<span class="n">Domain</span><span class="o">:</span> <span class="s">"test.com"</span><span class="p">,</span>
		<span class="n">MaxAge</span><span class="o">:</span> <span class="m">60</span><span class="p">,</span>
		<span class="n">Next</span><span class="o">:</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rw</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">expBody</span><span class="p">)</span>
		<span class="p">}),</span>
	<span class="p">}</span>

	<span class="n">testReq</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"/"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Failed to create test request: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">recorder</span> <span class="o">:=</span> <span class="n">httptest</span><span class="o">.</span><span class="n">NewRecorder</span><span class="p">()</span>
	<span class="n">loginHandler</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">recorder</span><span class="p">,</span> <span class="n">testReq</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">:=</span> <span class="n">recorder</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span>

	<span class="n">bodyBytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Failed to read the response: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="o">!</span><span class="n">bytes</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">bodyBytes</span><span class="p">,</span> <span class="n">expBody</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Unexpected response: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">cookies</span> <span class="o">:=</span> <span class="n">response</span><span class="o">.</span><span class="n">Cookies</span><span class="p">()</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span> <span class="o">!=</span> <span class="m">1</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Response returned more than one cookie"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">cookie</span> <span class="o">:=</span> <span class="n">cookies</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>

	<span class="k">if</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Value</span> <span class="o">!=</span> <span class="s">"logged in"</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Cookie has the wrong value. Expected %v, got %v"</span><span class="p">,</span> <span class="s">"logged in"</span><span class="p">,</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Domain</span> <span class="o">!=</span> <span class="s">"test.com"</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Cookie has the wrong domain. Expected %v, got %v"</span><span class="p">,</span> <span class="s">"test.com"</span><span class="p">,</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Domain</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Name</span> <span class="o">!=</span> <span class="s">"session"</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Cookie has the wrong name. Expected %v, got %v"</span><span class="p">,</span> <span class="s">"session"</span><span class="p">,</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Path</span> <span class="o">!=</span> <span class="s">"/"</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Cookie has the wrong domain. Expected %v, got %v"</span><span class="p">,</span> <span class="s">"/"</span><span class="p">,</span> <span class="n">cookie</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">cookie</span><span class="o">.</span><span class="n">MaxAge</span> <span class="o">!=</span> <span class="m">60</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Cookie has the wrong max age. Expected %v, got %v"</span><span class="p">,</span> <span class="m">60</span><span class="p">,</span> <span class="n">cookie</span><span class="o">.</span><span class="n">MaxAge</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>In the test we create an instance of our login handler in line 16. We use hard-coded values for our cookie attributes, and for our chained handler we again create an anonymous one that will write <code>"test!"</code> to the response. On line 27 we create a simple <code>http.Request</code> object, and then in lines 32 to 34 we create a new <code>ResponseRecorder</code> and pass it as a parameter to our login handler <code>ServeHTTP</code> method alongside our HTTP request, and store the result of the recorder.</p>

<p>After this, all that is left is to get the cookies from the response, assert that only one of them exists, and then proceed to check all the attributes we’re interested in using the standard Go test assertion mechanisms.</p>

<p>And that’s it!</p>

<p>If you are interested in a complete example of this code, deployable to Heroku, you can find it in this Github repository: <a href="https://github.com/brafales/go-session" rel="noopener" target="_blank">https://github.com/brafales/go-session</a>.</p>

<p>PS: you will have noticed that the login and logout handlers look almost exactly the same. It may be a good exercise for the reader to refactor them into a single handler that we can configure to behave as login or logout. Good luck!</p>

  </div>

</article>

<div class="pagination">

  <a class="previous" href="/2018/05/19/redirect-parts-website-applications-apache/">&laquo; Redirect parts of your website to different applications with Apache</a>


  <a class="next" href="/2018/08/25/walk-through-flang-part-7/">Walk-through flang – Part 7 &raquo;</a>

</div>



      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Powered by <a href="https://jekyllrb.com">Jekyll</a>. Theme based on <a href="https://github.com/yous/whiteglass">whiteglass</a>
<br>
Subscribe via <a href="https://thinkingeek.com/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
