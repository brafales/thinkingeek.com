<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Think In Geek</title>
  <meta name="description" content="In geek we trust">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://thinkingeek.com/posts/19/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Think In Geek" href="https://thinkingeek.com/feed.xml">

  

  
  <meta property="og:title" content="Think In Geek">
  <meta property="og:site_name" content="Think In Geek">
  <meta property="og:url" content="https://thinkingeek.com/posts/19/">
  <meta property="og:description" content="In geek we trust">
  
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Think In Geek">
  <meta name="twitter:description" content="In geek we trust">
  
  

  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

      <span class="site-title"><a href="/">Think In Geek</a> | </span>
      <span class="site-slogan">In geek we trust</span>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/arm-assembler-raspberry-pi/">Arm Assembler Raspberry Pi</a>
      
        
        <a class="page-link" href="/gcc-tiny/">GCC tiny</a>
      
        
        <a class="page-link" href="/author/brafales/">Posts by Bernat Ràfales</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">

  

  

  <ul class="post-list">
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            
              <a class="post-link" href="/2012/12/26/fast-easy-block-bots-website-apache/">Fast and easy way to block bots from your website using Apache</a>
            
          </h1>

          <p class="post-meta">
            Dec 26, 2012
             • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span>
            
               •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/uncategorized/">Uncategorized</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/apache/">apache</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/security/">security</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


            
            
          </p>
        </header>

        <div class="post-content">
          <p>Some weeks ago the site I work on started having severe outages. It looked like the system was not able to fulfill the incoming requests fast enough, making the passenger queue to grow faster than new requests could be served.</p>

<p>Looking at the rails logs it looked like some Chinese bot was crawling the entire site, including a long list of dynamic pages that took a long time to generate and that are not usually visited. Those pages were not yet cached, so every request went through the rails pipeline. Once you start having the dreadful problem of your passenger queue to grow faster and faster you are usually doomed.</p>

<p>Since you can’t expect some of the malicious bots out there to respect the <code>robots.txt</code> file, I had to filter those requests at the Apache level so they did not even reach the application level. This past few months I’ve been learning a lot of systems administration, basically because it’s us, the developers, who also handle this part of the business.</p>

<p>Since all those requests came from the same <code>user agent</code>, I looked for a simple way to filter the requests based on this criteria. It can be easily done if you use the <a href="http://httpd.apache.org/docs/2.0/mod/mod_access.html" target="_blank"><code>mod_access</code></a> Apache module. All you need to do is make use of the <code>Allow</code> and <code>Deny</code> directives. Here’s a simple example to filter the <code>ezooms</code> bot:</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">&lt;Directory "/home/rails/sites/prod/your_site/current/public"&gt;
    SetEnvIf User-Agent "ezooms" BlockUA
    Order allow,deny
    Deny from env=BlockUA
    Allow from all
&lt;/Directory&gt;</code></pre></figure>

<p>What this piece of code does is very self explanatory. The first line tells Apache to set up an environment variable called <code>BlockUA</code> if the <code>user agent</code> of the request matches the “<code>ezooms</code>” string. Then you tell Apache the order it has to evaluate the access control to the directory: it first has to evaluate the <code>Allow</code> directive, and then the <code>Deny</code> one. After that you set up both directives. <code>Allow from all</code> basically allows everything in. <code>Deny from env=BlockUA</code> denies all requests in which the environment variable <code>BlockUA</code> has been set. Since that variable is set up when the <code>user agent</code> matches our desired string, the config will basically deny access to the application to all requests with the “<code>ezooms</code>” user agent.</p>

<p>This way you can easily protect yourself from basic bot attacks.</p>

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            
              <a class="post-link" href="/2012/12/12/node-js-packages-mountain-lion/">Node.js packages in Mountain Lion</a>
            
          </h1>

          <p class="post-meta">
            Dec 12, 2012
             • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span>
            
               •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/uncategorized/">Uncategorized</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/mac-os-x/">mac os x</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/mountain-lion/">mountain lion</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/node-js/">node.js</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


            
            
          </p>
        </header>

        <div class="post-content">
          <p><strong>tl;dr</strong>: make sure you add <code>/usr/local/share/npm/bin</code> to your <code>PATH</code> when installing node.js to be able to access the package binaries.</p>

<p>Developing in Ruby on Rails on a Mountain Lion environment can be a pain. Although it’s a UNIX-like environment, most of the tools created for web development have been made with Linux in mind, and making the switch from a Linux box to Mac OS X is far from harmless.</p>

<p>Anyway, the other day I needed to tweak <a href="http://twitter.github.com/bootstrap/" target="_blank">Bootstrap</a> to make the default grid wider, and instead of using the Bootstrap web site customiser, I decided to download the <a href="https://github.com/twitter/bootstrap" target="_blank">source code from GitHub</a> and build it myself.</p>

<p>In order to do this, you need <a href="http://nodejs.org/" target="_blank">node.js</a> and some of the packages that come with it. I’ve never developed or even played with node.js before, so I needed to install it on the computer. And that was fairly easy thanks to <a href="http://mxcl.github.com/homebrew/" target="_blank">homebrew</a> by simply issuing the command <code>brew install node</code>.</p>

<p>After node has been installed you have access to <code>npm</code>, the node package manager. Following the Bootstrap instructions, I installed the necessary packages:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">npm <span class="nb">install </span>recess connect uglify-js jshint <span class="nt">-g</span></code></pre></figure>

<p>After that I thought I was ready to build Bootstrap, but the make command complained about not being able to find some of the node.js binaries I’ve just installed a minute ago.</p>

<p>The solution to the problem, though, was rather simple. It turns out the default formula for nodejs on homebrew doesn’t tell you the folder in which the node.js binaries will be installed in. Without adding this folder to the path, obviously the system can’t find the files it’s supposed to execute.</p>

<p>Simply add the folder <code>/usr/local/share/npm/bin</code> to your <code>PATH</code> environment variable and you’ll be good to go.</p>

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            
              <a class="post-link" href="/2012/11/17/mac-os-x-iterm-meta-key/">Mac OS X, iTerm and the meta key</a>
            
          </h1>

          <p class="post-meta">
            Nov 17, 2012
             • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span>
            
               •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/uncategorized/">Uncategorized</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/iterm/">iterm</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/mac-os-x/">mac os x</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/shell/">shell</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


            
            
          </p>
        </header>

        <div class="post-content">
          <p>
If you use your Mac OS X as a development machine and are a regular user of the shell, chances are you are going to be using the <a href="http://www.math.utah.edu/docs/info/features_7.html" target="_blank">movement commands</a> a lot. Chances are, too, that you are using <a href="http://www.iterm2.com" target="_blank">iTerm</a> instead of the system provided Terminal app.
</p>

<p>
Using the arrow keys is usually enough, but more often than not you need to move between words. This movements, unless you redefine it in your global or local bashrc profile (or any similar shell you maybe using), are done with the keys <code>b</code> and <code>f</code>. Pressing <code>C-b</code> or <code>C-f</code> moves the cursor one character back or forward. Doing if with <code>M-b</code> or <code>M-f</code> does the same but with a word (if you are an Emacs user you will be familiar with those key shortcuts).
</p>

<p>
The <code>C</code> stands for <code>control key</code>, while the <code>M</code> stands for <code>meta key</code>. In most keyboards (or keymaps to be precise), the control key is mapped to the <code>ctrl</code> key and the meta key is mapped to the <code>alt</code> key. In Mac OS X, the meta key is mapped to the <code>alt</code> key, but as you may very well know, this alt key is known as the <code>option</code> key, and has its peculiarities.
</p>

<p>
Now, if you open a shell in iTerm and press <code>C-b</code> or <code>C-f</code>, the output will be as expected, but not if you press <code>M-b</code> or <code>M-f</code>. Instead of moving forward or backward a word, you will see that some weird character is written on the command line.
</p>

<p>
Fortunately this is really easy to fix in iTerm. You just need to go to the Profiles menu, edit your profile (which is most likely to be the default one), and then go to the keys tab. Now, on the bottom of the keymap lists, you will see that you can configure the behaviour of the option key. Set it up to the last option (+Esc) as shown in the screenshot, and then the alt key in iTerm will be sending the shell the adequate escape sequence so all meta mappings work as expected.
</p>

<figure>
<a href="/wp-content/uploads/2012/11/Screen-Shot-2012-11-16-at-17.35.09.png"><img class="size-medium wp-image-310 " title="iTerm profile editor" src="/wp-content/uploads/2012/11/Screen-Shot-2012-11-16-at-17.35.09-300x175.png" alt="iTerm profile editor" width="300" height="175" /></a> <figcaption>iTerm profile editor</figcaption>
</figure>

<p>
<strong>EDIT (30/11/2012)</strong>: looks like this breaks some of the characters that are used by typing the meta key, i.e. the # character (meta + 3). Another way to achieve what we want is to manually map all the meta key shortcuts. This can be done in the same window as before. Select Normal instead of +Esc and, for each key shortcut you want to map, click on the + button. On the opening dialog, type the combination you want to map, for example alt + d, and select Send escape sequence from the drop down  Then on the last textbox insert the escape sequence character you want to send (typically the same pressed along the meta key).
</p>

<figure>
<a href="/wp-content/uploads/2012/11/Screen-Shot-2012-11-30-at-09.33.34.png"><img class="size-medium wp-image-316" title="Select Send Escape Sequence" src="/wp-content/uploads/2012/11/Screen-Shot-2012-11-30-at-09.33.34-298x300.png" alt="" width="297" height="300" /></a> <figcaption>Select Send Escape Sequence</figcaption>
</figure>

<figure>
<a href="/wp-content/uploads/2012/11/Screen-Shot-2012-11-30-at-09.34.11.png"><img class="size-medium wp-image-317" title="Type the character to send" src="/wp-content/uploads/2012/11/Screen-Shot-2012-11-30-at-09.34.11-300x175.png" alt="" width="300" height="175" /></a> <figcaption>Type the character to send</figcaption>
</figure>

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            
              <a class="post-link" href="/2012/11/05/never-again-buy-apple-product/">Why I will never buy an Apple product again</a>
            
          </h1>

          <p class="post-meta">
            Nov 5, 2012
             • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span>
            
               •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/uncategorized/">Uncategorized</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/apple/">apple</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


            
            
          </p>
        </header>

        <div class="post-content">
          <p>Well, here it is. This is not a tech post. Not a programming post either. This is just a rant I really needed to put online for some people to know. Also, I know this will never appear on <a href="http://news.ycombinator.com/" target="_blank">Hacker News</a> but I always wanted to write one of those “why I &lt;type here a randomly shit nobody really cares about&gt;” posts :)</p>

<p>tl;dr: Apple are a bunch of jokers.</p>

<p>Here’s the story. Last week my MacBook decided to refuse booting. It’s a late 2008 model (the first Unibody), and I was hoping it wasn’t because of a hardware issue. Actually, the machine booted, but it would refuse to show the login screen after the initial load and the second appearance of the Apple logo. For the record, I had Mountain Lion installed on it and have had no problems so far. After trying some things like repairing disk permissions, clearing the NVRAM, do a safe boot and some other black magic suggested in the Apple support pages and <a href="https://twitter.com/frikjan" target="_blank">a good friend who happens to know a lot about the Mac world</a>, I came to the conclusion that the problem was really not repairable and decided to go for a clean Mountain Lion install.</p>

<p>After booting the box into a Ubuntu Live CD and backing up some non essential files that I’d rather not lose either, I reinstalled Mountain Lion. Everything was fine. I had now a clean Mountain Lion installation on a laptop without any noticeable hardware issues. I had just only lost some hours of my time. No big deal.</p>

<p>But then I went to the Mac App Store to redownload and reinstall iPhoto. To my surprise, the App did not appear as purchased. The system was asking me to pay the £13 or so it cost. The thing is, I had already purchased iPhoto 3 months ago. So I decided to email Apple support and ask for help.</p>

<p>This was the answer: “<em>You purchased iPhoto when your Apple ID country was Spain, and then you changed your Apple ID country to United Kingdom, so you lost  all purchases made while your ID was linked to Spain</em>”. And this is in fact true: I moved from Barcelona to London 3 months ago and decided to change my Apple ID country to the UK. What I did certainly not know is that stupid policy of you losing all purchases when changing countries.</p>

<p>So I replied Customer Service to actually get a clarification on that, and the answer was crystal clear: “<em>yes, all purchases in the App Store are linked to the country of your Apple ID, so if you change it, you lose the purchases</em>”.</p>

<p>It seems this is no recent news, as a search on the internet showed <a href="http://deplinenoise.wordpress.com/2012/08/25/the-app-store-nightmare/" target="_blank">different people having to deal with the same issue</a>. But this did not make it less stupid. What kind on nonsense and stupid policy is that?</p>

<p>I could understand a similar policy with movies or music, as all those monster major distribution companies issue rights to watch or listen to certain material on a country basis. This is obviously a matter for another post and another site. But for software? And even worse, software being developed and sold by Apple themselves?</p>

<p>When did we all go so fucking crazy about everything?</p>

<p>So I asked Apple again: “<em>are you telling me that I bought a software from you 3 months ago to run on this machine, and now, 3 months later, after having to do a system clean installation, on the same fucking machine, I have to pay AGAIN for the same fucking software?</em>” The answer was clear again: “<em>yes, I’m aware this is not the answer you were expecting but it’s how it works</em>”. And then this hilarious predefined quote at the bottom of the email telling me “<em>how happy we are to have you as a member of the Apple family</em>”. Ha!</p>

<p>Searching on google again, I found out some people managed to get a refund because of that, so I thought I had nothing to lose to try. I emailed again (and did the same through the feedback links on Apple’s web site asking for a refund and telling them as nicely as I was able to do given the fucking circumstances that I felt like I was treated like garbage.</p>

<p>Let’s be honest. I am not one of those really old Apple customers. This MacBook was my second one and besides that I’ve <em>only</em> owned an iPod mini, two iPhones and an iPad (and I have to say the overall experience with both those products and the company was clearly positive). So no, I am not one of those poor sad bastards that go queue during the night to get a fucking gadget the day it gets released (although I have to admit I’ve done that with the <em>World of Warcraft: The Burning Crusade</em> release). But this really has nothing to do with it. They just crossed the line. Again. And yes, I know there is some shitty legal things involved in all this regarding VAT and some other things, but this is NOTHING Apple can not get over to make an App purchase valid if you fucking move countries.</p>

<p>In the end Apple resolved my issue by giving me some redeem codes, not only for iPhoto but also for iMovie and GarageBand (apps that I do not use and I’m very unlikely to do so in the future), but not because of what happened, according to the Customer Service email, but because “<em>we have checked that the MacBook you bought came with iLife, so we are generous enough to let you fucking download again a software you already paid for 3 months ago</em>”.</p>

<p>Well, you know what? You’ve lost a customer for a fucking £13 App.</p>

<p>Good job, Apple.</p>

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            
              <a class="post-link" href="/2012/08/08/common-linking-issues-c/">Common linking issues in C++</a>
            
          </h1>

          <p class="post-meta">
            Aug 8, 2012
             • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roger Ferrer Ibáñez</span></span>
            
               •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/uncategorized/">Uncategorized</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  




            
            
          </p>
        </header>

        <div class="post-content">
          <h2>Introduction</h2>

<p>
C++ is a language derived from C, so in essence all problems at link time boil down at declaring stuff but not defining it.
</p>

<p>
Declaring something in C++ means bringing the entity into existence in the program, so it can be used after the declaration point.  Defining something means giving a complete description of the entity itself.  You can declare a class or a function, and it means this class and this function do exist. But to completely describe a class and a function you have to define them. A class definition provides a list of base classes of that class, a list of members (data members and member functions) of that class, etc.  A function definition provides the executable code of that function. All definitions are declarations but not all declarations are definitions.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="code"><pre><span class="c1">// Defines variable 'x'</span>
<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="c1">// Declares variable 'y'</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
<span class="c1">// Declares class 'A'</span>
<span class="k">struct</span> <span class="nc">A</span><span class="p">;</span>
<span class="c1">// Declares function 'f(int)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>

<span class="c1">// Defines class 'A'</span>
<span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="c1">// Declares member function 'A::g(float)'</span>
    <span class="kt">void</span> <span class="n">g</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>

    <span class="c1">// Defines member function 'A::h(char)'</span>
    <span class="kt">void</span> <span class="n">h</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> 
    <span class="p">{</span> 
      <span class="c1">// Code</span>
    <span class="p">}</span>

    <span class="c1">// Defines data member 'A::x'</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

    <span class="c1">// Declares static data member 'A::y'</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Defines  function'f(int)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">{</span>
 <span class="c1">// Code</span>
<span class="p">}</span>

<span class="c1">// Defines member function 'A::g(float)'</span>
<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">g</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span>
<span class="p">{</span>
 <span class="c1">// Code</span>
<span class="p">}</span>

<span class="c1">// Defines static data member 'A::y'</span>
<span class="kt">int</span> <span class="n">A</span><span class="o">::</span><span class="n">y</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
C++, in contrast to C, strongly sticks to the One Definition Rule which states that entities can be defined at most once in an entire program. Of course this may not be completely true depending your own the definition of "entity": template functions when instantiated by the compiler can be defined more than once in the program, and some magic happens so this does not become a problem.
</p>

<p>
Anyway, C++ brings its own set of linking issues which may fool even the most experienced C++ developer.
</p>

<h2>Static data members are only declared inside the class specifier</h2>

<p>
Some might argue that this is one of the most common source of linking issues when using C++. Truth be told, static data members are just global variables in disguise so most people will avoid them. However, there are cases where a static data member may come in handy, for instance when implementing the singleton pattern.
</p>

<p>
The problem lies that, although usual (nonstatic) data members are defined when they are declared inside a class (like in line 23 of the example above), static data members are only declared.  Thus in line 26 of the example above <code>A::y</code> is only being declared.  Its actual definition is given in line 42. The actual definition of a static data member will go in the implementation file (usually a <code>.cpp</code> or <code>.cc</code> file).
</p>

<p>
So the usual case goes like this: you realize you need a static data member. You add it to the class. Your code compiles fine but does not link. In fact 'A::y', the static data member you just added is undefined? How can this be? 
</p>

<p>
Now you know the reason.
</p>

<p>
What is the reason this issue is hit so many times? Well, there are three reasons. A historical one, where early versions of C++ compilers allowed this. A quirk in the C++ language itself where <code>const</code> integral and enumerator static data members can be declared and initialized in the class itself (thus defining them as well). And finally, a <q>linguistic</q> issue, since in Java and C# static fields are declared like any other fields plus a <code>static</code> specifier.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="c1">// -- Header file</span>
<span class="k">class</span> <span class="nc">MySingleton</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">static</span> <span class="n">MySingleton</span><span class="o">&amp;</span> <span class="n">getInstance</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">singleton_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">singleton_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MySingleton</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">singleton_</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="c1">// Usual private constructor</span>
    <span class="n">MySingleton</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="c1">// Declaration</span>
    <span class="k">static</span> <span class="n">MySingleton</span> <span class="o">*</span><span class="n">singleton_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// -- Implementation file</span>
<span class="c1">// Definition</span>
<span class="n">MySingleton</span><span class="o">*</span> <span class="n">MySingleton</span><span class="o">::</span><span class="n">singleton_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2>Not all headers are created equal</h2>

<p>
The usual myth is that C++ is a superset of C. Well, it looks like as a superset of C but they are actually two different languages. That said, they share so many thinks that interfacing C++ and C is pretty straightforward, in particular when the former must call the latter (the opposite may be a bit more challenging).
</p>

<p>
Thus, it is not unsual to see that a C++ program <code>#include</code>s C header files. Chances are that the headers of your operating system will be in C. Being able to #include a C header and using the entities declared in it is one of the strengths of C++. And this is the source of our second problem.
</p>

<p>
Remember that in C++ functions may be overloaded. This means that we can use the same name when declaring two functions in the same scope as long as they have different enough parameter types.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="c1">// Declaration of 'f(int)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="c1">// Declaration of 'f(float)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
<span class="c1">// Redeclaration of 'f(int)' since, in a parameter, 'const int' cannot</span>
<span class="c1">// be distinguished from 'int'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
It may be non obvious, but we cannot give these two functions declared above the same <code>f</code> name.  So the compiler crafts an artificial name for <code>f(int)</code> and <code>f(float)</code> (this is called a decorated name or a mangled name). For instance they could be <code>f_1_int</code> and <code>f_1_float</code> (here 1 would mean the number of parameters). The C++ compiler will internally use these names when generating code and the lower levels will just see two diferent names.
</p>

<p>
But overloading cannot be applied to C. Thus we run into a problem here. If we <code>#include</code> C headers, the names of these functions cannot be overloaded thus a C compiler will generated code using the (undecorated) name of the function.  If our C++ compiler always uses a decorated name, there will be an unresolved symbol. The C++ compiler cannot tell if this is C or C++.  Can it?
</p>

<p>
Good news, it can. You can define the linkage of declarations in the code. By default linkage is <code>C++</code> so overload works as described above. When you want to <code>#include</code> a C header, you will have to tell the C++ compiler that the linkage of the declarations is C, not C++. Most of the time you will find these lines in the beginning of a C header intended to be used from C++.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="c1">// Remember this is a C header so protect ourselves when this is compiled using C</span>
<span class="cp">#ifdef __cplusplus 
</span><span class="c1">// This 'extern "C"' syntax is only valid in C++, not in C.</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span> 
<span class="c1">// From now everything has C linkage. </span>
<span class="cp">#endif
</span>
<span class="cm">/* Library declarations in C */</span>

<span class="cp">#ifdef __cplusplus 
</span><span class="c1">// Close the brace opened above</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2>Virtual member functions and virtual tables</h2>

<p>
Finally one of the, in my opinion, most confusing link errors when using a C++ compilers: virtual table unresolved references.
</p>

<p>
Virtual member functions are, in C++ parlance, polymorphic methods of other programming languages (like Java). Virtual member functions can be overridden by derived classes (descendant classes) thus when called, they must be dispatched dinamically.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf2</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="nc">B</span> <span class="o">:</span> <span class="n">A</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf3</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">virtual</span> <span class="n">B</span><span class="o">::</span><span class="n">vmf</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Code</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">*</span> <span class="n">pa</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">pfl</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Dynamic dispatch </span>
  <span class="c1">// we don't really know if A::vmf or B::vmf will be called</span>
  <span class="n">pa</span><span class="o">-&gt;</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>

  <span class="c1">// Static call to A::vmf since we qualified the function being called</span>
  <span class="n">pa</span><span class="o">-&gt;</span><span class="n">A</span><span class="o">::</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>

  <span class="n">B</span> <span class="n">b</span><span class="p">;</span>
  <span class="c1">// Static call to B::vmf, no doubts here since the dynamic type (in memory)</span>
  <span class="c1">// of 'b' and its declared type must be the same</span>
  <span class="n">b</span><span class="p">.</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>

  <span class="n">A</span><span class="o">&amp;</span> <span class="n">ra</span><span class="p">(</span><span class="o">*</span><span class="n">pa</span><span class="p">);</span>
  <span class="c1">// Dynamic dispatch again</span>
  <span class="n">ra</span><span class="p">.</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
Dynamic dispatch is implemented using a virtual method table (or vtable).  Every class with virtual methods (called a dynamic class) has a vtable.  This vtable is a sequence of addresses to member functions. Every virtual member function is assigned an index in this table and the addresses points to the function implementing the virtual member function for that class. For instance class <code>A</code> above has two member functions <code>vmf</code> and <code>vmf2</code>. The vtable of <code>A</code>, then will have two entries, 0 and 1, and will point to the functions <code>A::vmf</code> and <code>A::vmf2</code> respectively. The vtable of <code>B</code> will have three entries, 0, 1, 2, that will point to functions <code>B::vmf</code>, <code>A::vmf2</code> and <code>B::vmf3</code> respectively.
</p>

<p>
Every object of a dynamic class has a hidden data member (called the virtual pointer) that points to the vtable of its class. When C++ specifies that a call goes through dynamic dispatch (in C++ parlance, a call to the ultimate overrider), we do not call directly any function but instead, through this hidden data member, we reach the vtable and using the index of the virtual member function being called, we retrieve the entry containing the addresses to the real function. Then this addresses is used in an indirect call.
</p>

<p>
Since both the virtual table and the virtual pointer are hidden from the eyes of the developer, sometimes errors in our code may cause link errors.
</p>

<h3>The compiler does not emit a vtable</h3>

<p>
This may not apply to all C++ compilers, but usually a C++ compiler only emits a vtable when it finds a definition of a virtual member function. Note that virtual member function definitions for a given class may be scattered in several files. Magic happens again so more than one definition of the vtable of a given class in several files does not become a problem at link time.
</p>

<p>
But, what if you forget to define all virtual functions? This may look contrived but in my experience this may happen by accident. The problem lies on the error at link time, which is really confusing.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">x_</span><span class="p">;</span>
    <span class="n">A</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">x_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="c1">// We forget to define A::foo</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">quux</span><span class="p">(</span><span class="n">A</span><span class="o">*</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Dynamic dispatch</span>
    <span class="n">a</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">A</span> <span class="n">a</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">quux</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
If you compile and link this with g++ (I use <code>-g</code> since it improves link error messages by using the debugging information).
</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">$ g++ -o prova test.cc -g
/tmp/ccl71r2A.o: In function `A':
test.cc:4: undefined reference to `vtable for A'
collect2: ld returned 1 exit status</code></pre></figure>

<p>
But the line 4 is the constructor. You see now how confusing this message is, don't you? What is going on?
</p>

<p>
Well, everything makes sense if we remember that hidden data member I mentioned above, the virtual pointer. As a data member of a class it must be initialized in the constructor. It is initialized with the address of the virtual table of A. But the virtual table of A was not emitted since we forgot to define <strong>all</strong> virtual member functions. Thus, unresolved reference for the virtual table.  
</p>

<h3>Missing virtual member functions in base classes</h3>

<p>
Remember that the vtable contains entries for all the virtual member functions of the base tables. The vtable is statically initialized (this is, the compiler "hardcodes" in the generated code, in the data section) the addresses of each entry. What if we forget to define a virtual member function of a base class?
</p>

<p>
Consider this example
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">x_</span><span class="p">;</span>
    <span class="n">A</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">x_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
    <span class="c1">// We forget to define A::foo2</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo2</span><span class="p">();</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">foo</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="c1">// Definition of A::foo</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">B</span> <span class="o">:</span> <span class="n">A</span> 
<span class="p">{</span>
    <span class="n">B</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">A</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">()</span> 
    <span class="p">{</span> 
        <span class="c1">// Definition of B::foo</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">quux</span><span class="p">(</span><span class="n">A</span><span class="o">*</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">a</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">B</span> <span class="n">b</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">quux</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
If we compile and link with g++ we get
</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">/tmp/cc4t9NG3.o:(.rodata._ZTV1B[vtable for B]+0xc): undefined reference to `A::foo2()'
/tmp/cc4t9NG3.o:(.rodata._ZTV1A[vtable for A]+0xc): undefined reference to `A::foo2()'
collect2: ld returned 1 exit status</code></pre></figure>

<p>
This happens because vtables of <code>A</code> and <code>B</code> refer to <code>A::foo2</code>, but we forgot to define it. Fortunately, now the error message is easier to grasp: some function is missing.
</p>

<p>
Obviously, many more link errors caused by C++ exist, but I think the ones shown here are quite common and the error messages related to them are quite confusing.
</p>

        </div>
        
      </li>
    
  </ul>

  
  <div class="pagination">
    
      <a class="previous" href="/posts/20/">&laquo; Older</a>
    

    
      <a class="next" href="/posts/18/">Newer &raquo;</a>
    
  </div>



</div>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Powered by <a href="https://jekyllrb.com">Jekyll</a>. Theme based on <a href="https://github.com/yous/whiteglass">whiteglass</a>
<br>
Subscribe via <a href="https://thinkingeek.com/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
