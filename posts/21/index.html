<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Think In Geek</title>
  <meta name="description" content="In geek we trust">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://thinkingeek.com/posts/21/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Think In Geek" href="https://thinkingeek.com/feed.xml">

  

  
  <meta property="og:title" content="Think In Geek">
  <meta property="og:site_name" content="Think In Geek">
  <meta property="og:url" content="https://thinkingeek.com/posts/21/">
  <meta property="og:description" content="In geek we trust">
  
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Think In Geek">
  <meta name="twitter:description" content="In geek we trust">
  
  

  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

      <span class="site-title"><a href="/">Think In Geek</a> | </span>
      <span class="site-slogan">In geek we trust</span>

    <nav class="site-nav"><a class="page-link" href="/arm-assembler-raspberry-pi/">Arm Assembler Raspberry Pi</a><a class="page-link" href="/gcc-tiny/">GCC tiny</a><a class="page-link" href="/author/brafales/">Posts by Bernat Ràfales</a><a class="page-link" href="/archives/">Archives</a></nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">

  <ul class="post-list"><li>
        <header class="post-header">
          <h1 class="post-title"><a class="post-link" href="/2012/08/08/common-linking-issues-c/">Common linking issues in C++</a></h1>

          <p class="post-meta">
            Aug 8, 2012• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roger Ferrer Ibáñez</span></span> • <a href="/categories/uncategorized/">Uncategorized</a></p>
        </header>

        <div class="post-content">
          <h2>Introduction</h2>

<p>
C++ is a language derived from C, so in essence all problems at link time boil down at declaring stuff but not defining it.
</p>

<p>
Declaring something in C++ means bringing the entity into existence in the program, so it can be used after the declaration point.  Defining something means giving a complete description of the entity itself.  You can declare a class or a function, and it means this class and this function do exist. But to completely describe a class and a function you have to define them. A class definition provides a list of base classes of that class, a list of members (data members and member functions) of that class, etc.  A function definition provides the executable code of that function. All definitions are declarations but not all declarations are definitions.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="code"><pre><span class="c1">// Defines variable 'x'</span>
<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="c1">// Declares variable 'y'</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
<span class="c1">// Declares class 'A'</span>
<span class="k">struct</span> <span class="nc">A</span><span class="p">;</span>
<span class="c1">// Declares function 'f(int)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>

<span class="c1">// Defines class 'A'</span>
<span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="c1">// Declares member function 'A::g(float)'</span>
    <span class="kt">void</span> <span class="n">g</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>

    <span class="c1">// Defines member function 'A::h(char)'</span>
    <span class="kt">void</span> <span class="n">h</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> 
    <span class="p">{</span> 
      <span class="c1">// Code</span>
    <span class="p">}</span>

    <span class="c1">// Defines data member 'A::x'</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

    <span class="c1">// Declares static data member 'A::y'</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Defines  function'f(int)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">{</span>
 <span class="c1">// Code</span>
<span class="p">}</span>

<span class="c1">// Defines member function 'A::g(float)'</span>
<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">g</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span>
<span class="p">{</span>
 <span class="c1">// Code</span>
<span class="p">}</span>

<span class="c1">// Defines static data member 'A::y'</span>
<span class="kt">int</span> <span class="n">A</span><span class="o">::</span><span class="n">y</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
C++, in contrast to C, strongly sticks to the One Definition Rule which states that entities can be defined at most once in an entire program. Of course this may not be completely true depending your own the definition of "entity": template functions when instantiated by the compiler can be defined more than once in the program, and some magic happens so this does not become a problem.
</p>

<p>
Anyway, C++ brings its own set of linking issues which may fool even the most experienced C++ developer.
</p>

<h2>Static data members are only declared inside the class specifier</h2>

<p>
Some might argue that this is one of the most common source of linking issues when using C++. Truth be told, static data members are just global variables in disguise so most people will avoid them. However, there are cases where a static data member may come in handy, for instance when implementing the singleton pattern.
</p>

<p>
The problem lies that, although usual (nonstatic) data members are defined when they are declared inside a class (like in line 23 of the example above), static data members are only declared.  Thus in line 26 of the example above <code>A::y</code> is only being declared.  Its actual definition is given in line 42. The actual definition of a static data member will go in the implementation file (usually a <code>.cpp</code> or <code>.cc</code> file).
</p>

<p>
So the usual case goes like this: you realize you need a static data member. You add it to the class. Your code compiles fine but does not link. In fact 'A::y', the static data member you just added is undefined? How can this be? 
</p>

<p>
Now you know the reason.
</p>

<p>
What is the reason this issue is hit so many times? Well, there are three reasons. A historical one, where early versions of C++ compilers allowed this. A quirk in the C++ language itself where <code>const</code> integral and enumerator static data members can be declared and initialized in the class itself (thus defining them as well). And finally, a <q>linguistic</q> issue, since in Java and C# static fields are declared like any other fields plus a <code>static</code> specifier.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="c1">// -- Header file</span>
<span class="k">class</span> <span class="nc">MySingleton</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">static</span> <span class="n">MySingleton</span><span class="o">&amp;</span> <span class="n">getInstance</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">singleton_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">singleton_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MySingleton</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">singleton_</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="c1">// Usual private constructor</span>
    <span class="n">MySingleton</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="c1">// Declaration</span>
    <span class="k">static</span> <span class="n">MySingleton</span> <span class="o">*</span><span class="n">singleton_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// -- Implementation file</span>
<span class="c1">// Definition</span>
<span class="n">MySingleton</span><span class="o">*</span> <span class="n">MySingleton</span><span class="o">::</span><span class="n">singleton_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2>Not all headers are created equal</h2>

<p>
The usual myth is that C++ is a superset of C. Well, it looks like as a superset of C but they are actually two different languages. That said, they share so many thinks that interfacing C++ and C is pretty straightforward, in particular when the former must call the latter (the opposite may be a bit more challenging).
</p>

<p>
Thus, it is not unsual to see that a C++ program <code>#include</code>s C header files. Chances are that the headers of your operating system will be in C. Being able to #include a C header and using the entities declared in it is one of the strengths of C++. And this is the source of our second problem.
</p>

<p>
Remember that in C++ functions may be overloaded. This means that we can use the same name when declaring two functions in the same scope as long as they have different enough parameter types.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="c1">// Declaration of 'f(int)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="c1">// Declaration of 'f(float)'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
<span class="c1">// Redeclaration of 'f(int)' since, in a parameter, 'const int' cannot</span>
<span class="c1">// be distinguished from 'int'</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
It may be non obvious, but we cannot give these two functions declared above the same <code>f</code> name.  So the compiler crafts an artificial name for <code>f(int)</code> and <code>f(float)</code> (this is called a decorated name or a mangled name). For instance they could be <code>f_1_int</code> and <code>f_1_float</code> (here 1 would mean the number of parameters). The C++ compiler will internally use these names when generating code and the lower levels will just see two diferent names.
</p>

<p>
But overloading cannot be applied to C. Thus we run into a problem here. If we <code>#include</code> C headers, the names of these functions cannot be overloaded thus a C compiler will generated code using the (undecorated) name of the function.  If our C++ compiler always uses a decorated name, there will be an unresolved symbol. The C++ compiler cannot tell if this is C or C++.  Can it?
</p>

<p>
Good news, it can. You can define the linkage of declarations in the code. By default linkage is <code>C++</code> so overload works as described above. When you want to <code>#include</code> a C header, you will have to tell the C++ compiler that the linkage of the declarations is C, not C++. Most of the time you will find these lines in the beginning of a C header intended to be used from C++.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="c1">// Remember this is a C header so protect ourselves when this is compiled using C</span>
<span class="cp">#ifdef __cplusplus 
</span><span class="c1">// This 'extern "C"' syntax is only valid in C++, not in C.</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span> 
<span class="c1">// From now everything has C linkage. </span>
<span class="cp">#endif
</span>
<span class="cm">/* Library declarations in C */</span>

<span class="cp">#ifdef __cplusplus 
</span><span class="c1">// Close the brace opened above</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2>Virtual member functions and virtual tables</h2>

<p>
Finally one of the, in my opinion, most confusing link errors when using a C++ compilers: virtual table unresolved references.
</p>

<p>
Virtual member functions are, in C++ parlance, polymorphic methods of other programming languages (like Java). Virtual member functions can be overridden by derived classes (descendant classes) thus when called, they must be dispatched dinamically.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf2</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="nc">B</span> <span class="o">:</span> <span class="n">A</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">vmf3</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">virtual</span> <span class="n">B</span><span class="o">::</span><span class="n">vmf</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Code</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">*</span> <span class="n">pa</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">pfl</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Dynamic dispatch </span>
  <span class="c1">// we don't really know if A::vmf or B::vmf will be called</span>
  <span class="n">pa</span><span class="o">-&gt;</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>

  <span class="c1">// Static call to A::vmf since we qualified the function being called</span>
  <span class="n">pa</span><span class="o">-&gt;</span><span class="n">A</span><span class="o">::</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>

  <span class="n">B</span> <span class="n">b</span><span class="p">;</span>
  <span class="c1">// Static call to B::vmf, no doubts here since the dynamic type (in memory)</span>
  <span class="c1">// of 'b' and its declared type must be the same</span>
  <span class="n">b</span><span class="p">.</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>

  <span class="n">A</span><span class="o">&amp;</span> <span class="n">ra</span><span class="p">(</span><span class="o">*</span><span class="n">pa</span><span class="p">);</span>
  <span class="c1">// Dynamic dispatch again</span>
  <span class="n">ra</span><span class="p">.</span><span class="n">vmf</span><span class="p">(</span><span class="n">pfl</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
Dynamic dispatch is implemented using a virtual method table (or vtable).  Every class with virtual methods (called a dynamic class) has a vtable.  This vtable is a sequence of addresses to member functions. Every virtual member function is assigned an index in this table and the addresses points to the function implementing the virtual member function for that class. For instance class <code>A</code> above has two member functions <code>vmf</code> and <code>vmf2</code>. The vtable of <code>A</code>, then will have two entries, 0 and 1, and will point to the functions <code>A::vmf</code> and <code>A::vmf2</code> respectively. The vtable of <code>B</code> will have three entries, 0, 1, 2, that will point to functions <code>B::vmf</code>, <code>A::vmf2</code> and <code>B::vmf3</code> respectively.
</p>

<p>
Every object of a dynamic class has a hidden data member (called the virtual pointer) that points to the vtable of its class. When C++ specifies that a call goes through dynamic dispatch (in C++ parlance, a call to the ultimate overrider), we do not call directly any function but instead, through this hidden data member, we reach the vtable and using the index of the virtual member function being called, we retrieve the entry containing the addresses to the real function. Then this addresses is used in an indirect call.
</p>

<p>
Since both the virtual table and the virtual pointer are hidden from the eyes of the developer, sometimes errors in our code may cause link errors.
</p>

<h3>The compiler does not emit a vtable</h3>

<p>
This may not apply to all C++ compilers, but usually a C++ compiler only emits a vtable when it finds a definition of a virtual member function. Note that virtual member function definitions for a given class may be scattered in several files. Magic happens again so more than one definition of the vtable of a given class in several files does not become a problem at link time.
</p>

<p>
But, what if you forget to define all virtual functions? This may look contrived but in my experience this may happen by accident. The problem lies on the error at link time, which is really confusing.
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">x_</span><span class="p">;</span>
    <span class="n">A</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">x_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="c1">// We forget to define A::foo</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">quux</span><span class="p">(</span><span class="n">A</span><span class="o">*</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Dynamic dispatch</span>
    <span class="n">a</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">A</span> <span class="n">a</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">quux</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
If you compile and link this with g++ (I use <code>-g</code> since it improves link error messages by using the debugging information).
</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">$ g++ -o prova test.cc -g
/tmp/ccl71r2A.o: In function `A':
test.cc:4: undefined reference to `vtable for A'
collect2: ld returned 1 exit status</code></pre></figure>

<p>
But the line 4 is the constructor. You see now how confusing this message is, don't you? What is going on?
</p>

<p>
Well, everything makes sense if we remember that hidden data member I mentioned above, the virtual pointer. As a data member of a class it must be initialized in the constructor. It is initialized with the address of the virtual table of A. But the virtual table of A was not emitted since we forgot to define <strong>all</strong> virtual member functions. Thus, unresolved reference for the virtual table.  
</p>

<h3>Missing virtual member functions in base classes</h3>

<p>
Remember that the vtable contains entries for all the virtual member functions of the base tables. The vtable is statically initialized (this is, the compiler "hardcodes" in the generated code, in the data section) the addresses of each entry. What if we forget to define a virtual member function of a base class?
</p>

<p>
Consider this example
</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">A</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">x_</span><span class="p">;</span>
    <span class="n">A</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">x_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
    <span class="c1">// We forget to define A::foo2</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo2</span><span class="p">();</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">foo</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="c1">// Definition of A::foo</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">B</span> <span class="o">:</span> <span class="n">A</span> 
<span class="p">{</span>
    <span class="n">B</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">A</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">()</span> 
    <span class="p">{</span> 
        <span class="c1">// Definition of B::foo</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">quux</span><span class="p">(</span><span class="n">A</span><span class="o">*</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">a</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">B</span> <span class="n">b</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">quux</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>
If we compile and link with g++ we get
</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">/tmp/cc4t9NG3.o:(.rodata._ZTV1B[vtable for B]+0xc): undefined reference to `A::foo2()'
/tmp/cc4t9NG3.o:(.rodata._ZTV1A[vtable for A]+0xc): undefined reference to `A::foo2()'
collect2: ld returned 1 exit status</code></pre></figure>

<p>
This happens because vtables of <code>A</code> and <code>B</code> refer to <code>A::foo2</code>, but we forgot to define it. Fortunately, now the error message is easier to grasp: some function is missing.
</p>

<p>
Obviously, many more link errors caused by C++ exist, but I think the ones shown here are quite common and the error messages related to them are quite confusing.
</p>

        </div></li><li>
        <header class="post-header">
          <h1 class="post-title"><a class="post-link" href="/2012/07/29/crazy-stuff-c-1/">Crazy stuff in C++ (1)</a></h1>

          <p class="post-meta">
            Jul 29, 2012• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Roger Ferrer Ibáñez</span></span> • <a href="/categories/uncategorized/">Uncategorized</a> • <a href="/tags/classes/">classes</a>, <a href="/tags/cplusplus/">cplusplus</a>, <a href="/tags/functions/">functions</a>, <a href="/tags/specializations/">specializations</a>, <a href="/tags/templates/">templates</a></p>
        </header>

        <div class="post-content">
          <h2>Introduction</h2>
<p>C++ is a controversial language: you love it or you hate it. As always, knowing better about something allows one to make better arguments for or against that thing. This is what this series is about. Here I’ll explain some of the less known (except for C++ expert programmers, of course) features of C++.</p>

<p>Let’s start with templates, which account for such a huge part of the language.</p>
<h2>Templates</h2>
<p>Everyone knows that C++ has templates. Templates is an implementation of the «I have an algorithm that can be used with many different types» idea. This idea is called <a title="generic programming" href="http://en.wikipedia.org/wiki/Generic_programming" target="_blank">generic programming</a> and is a pretty powerful one. This is why it is present in almost all modern languages.</p>

<p>Back to C++. C++ defines two kinds of templates: <em>classes templates</em> and <em> function templates</em>. Class templates define an infinite set of classes while function templates define an infinite set of functions. The elements of these sets of classes or functions are called <em>specializations</em>. Every template has a <em>template-name</em> which will be used to name a specific specialization.</p>
<h3>Template declarations</h3>
<p>Consider these two declarations</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">my_list</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">max</span><span class="p">(</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>These are <em>template declarations</em>. The first one declares a class template and its template-name is <em>my_list</em>, the second one defines a function template and its template-name is <em>max</em>. A template declaration is just a declaration preceded with something without an official name that starts with <em>template &lt;…&gt;</em>, I will call it the <em>template header</em> (but note that this name is not blessed by the C++ standard at all, it just makes sense to me call it like this).</p>

<p>The template header defines what are the parameters of the template class. These are called the <em>template parameters</em>. A <em>type-template parameter</em>, like that <em>T</em> shown above, is a “type variable”. This is the most usual template parameter as it allows to parameterize the declaration over one or more type variables. C++, though, has two more kinds of template parameters:<em> nontype-template parameters</em> and (the funny named) <em>template-template parameter</em>. A nontype-template parameter allows us to parameterize the declaration over a (compile-time) constant integer value. Here “integer value” is a very broad term: of course it includes all integers, but also enum values (enumerators) and addresses of (statically allocated) variables and functions. A template-template parameter allows us to parameterize a declaration over another class template with appropiate template parameters.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">&gt;</span> <span class="c1">// N is a nontype-template parameter</span>
<span class="k">struct</span> <span class="nc">my_fixed_array</span> <span class="p">{</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="n">MyContainer</span><span class="p">&gt;</span> <span class="c1">// MyContainer is a template-template parameter</span>
<span class="k">struct</span> <span class="nc">adaptor</span> <span class="p">{</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2>Specializations</h2>
<p>I said above that a class template or function template defines an infinite set of classes or function and that each element of that set was called a specialization. There is a specialization for every possible value that a template parameter can have. Such values are not bounded thus there is an infinite number of specializations (well, we could argue that constant integer values are finite in the language, but types are clearly not finite).</p>

<p>We give value to template parameters of a template by means of <em>template arguments</em>. These template arguments always appear in what is called a <em>template-id</em>. A template-id is just the template-name followed by a list of template-arguments enclosed in &lt; and &gt;.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">my_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">l</span><span class="p">;</span><span class="c1">// Here T has value int, we will write it as T ← int</span>
<span class="n">max</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">3.4</span><span class="n">f</span><span class="p">,</span> <span class="mf">5.6</span><span class="n">f</span><span class="p">);</span> <span class="c1">// T ← float</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3>Primary template and partial specializations</h3>
<p>When we first declare a class template or a function template, such declaration defines the <em>primary template</em>.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">my_list</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Class templates (but not function templates!) can have an extra set of template declarations called <em>partial specializations</em>. A partial specialization looks like a normal class template declaration but the template-name is now a template-id where the template-arguments partially specialize the given template parameters.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="c1">// 1) Partial specialization for "pointer to (any) P" type</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">P</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">my_list</span><span class="o">&lt;</span><span class="n">P</span><span class="o">*&gt;</span> <span class="p">{</span> <span class="p">};</span> 

<span class="c1">// 2) Partial specialization for "array of (any) Size of (any) Element"</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Element</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Size</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">my_list</span><span class="o">&lt;</span><span class="n">Element</span><span class="p">[</span><span class="n">Size</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">};</span>

<span class="c1">// 3) Partial specialization for "pointer to function with two parameters </span>
<span class="c1">// Arg1 and Arg2 returning Ret"</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Ret</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Arg1</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Arg2</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">my_list</span><span class="o">&lt;</span><span class="n">Ret</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">Arg1</span><span class="p">,</span> <span class="n">Arg2</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>A C++ compiler will always pick the partial specialization (if any) that is “closer” to the one requested in the template arguments. If no partial specialization matches, the primary template is chosen instead. The exact algorithm is not important here.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="n">my_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">l0</span><span class="p">;</span> <span class="c1">// will pick the primary template T ← int</span>

<span class="n">my_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">*&gt;</span> <span class="n">l1</span><span class="p">;</span> <span class="c1">// will pick partial specialization 1) </span>
<span class="c1">// where P ← int (note that respect to the primary template this is T ← int*)</span>

<span class="n">my_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">l2</span><span class="p">;</span> <span class="c1">// will pick partial specialization 2) </span>
<span class="c1">// where Element ← int and Size ← 10</span>

<span class="n">my_list</span><span class="o">&lt;</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">float</span><span class="p">,</span> <span class="kt">double</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">l3</span><span class="p">;</span> <span class="c1">// will pick partial specialization 3) </span>
<span class="c1">// where Ret ← int, Arg1 ← float and Arg2 ← double</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I think this is enough for today regarding C++ templates. More craziness to come. Stay tuned.</p>

        </div></li><li>
        <header class="post-header">
          <h1 class="post-title"><a class="post-link" href="/2012/07/29/sending-emails-google-mail-ruby/">Sending emails using Google Mail with Ruby</a></h1>

          <p class="post-meta">
            Jul 29, 2012• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span> • <a href="/categories/uncategorized/">Uncategorized</a> • <a href="/tags/gmail/">gmail</a>, <a href="/tags/google/">google</a>, <a href="/tags/mail/">mail</a>, <a href="/tags/ruby/">ruby</a>, <a href="/tags/smtp/">smtp</a></p>
        </header>

        <div class="post-content">
          <p>
It's no secret that Google Mail has become, over the last years, the most widely used email server and client on the world. Not only it's basically free, but with the use of Google Apps you can even use it on your own domains.
</p>
<p>
Because so many people use it, even system administrators, it may be good to know how to use it to send system emails. Also, because Ruby is actually the only scripting language I feel comfortable with, I'll show you a simple library to send emails using Google SMTP server as an outgoing server, so you don't have to configure your server with sendmail, postfix or another typical UNIX mail server.
</p>
<p>
The first thing we will need is to include (and install) two gems:
<ul>
<li>net/smtp (actually this comes from the Standard Library on Ruby 1.9)</li>
<li>tlsmail</li>
</ul>
The first one will allow us to use some SMTP features in Ruby, and the second one will allow us to use TLS authentication for SMTP, the method used by Google Mail.
</p>
<p>
With those two libraries, we can already send a simple email, using the standard SMTP format:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">send_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mailtext</span>
  <span class="k">begin</span> 
    <span class="no">Net</span><span class="o">::</span><span class="no">SMTP</span><span class="p">.</span><span class="nf">enable_tls</span><span class="p">(</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_NONE</span><span class="p">)</span>
    <span class="no">Net</span><span class="o">::</span><span class="no">SMTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:smtp_server</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:port</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:helo</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:username</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:password</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:authentication</span><span class="p">])</span> <span class="k">do</span> <span class="o">|</span><span class="n">smtp</span><span class="o">|</span>
      <span class="n">smtp</span><span class="p">.</span><span class="nf">send_message</span> <span class="n">mailtext</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>  
    <span class="k">raise</span> <span class="s2">"Exception occured: </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2"> "</span>
    <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">end</span>  
<span class="k">end</span></code></pre></figure>

</p>
<p>
You can see here that the SMTP info is stored in a variable <code>@smtp_info</code>. We will take care of that later. Also, the variable <code>mailtext</code> passed to the method also needs a special format. More on that later as well. The really important fragment of code here is the one that calls <code>enable_tls</code> on the <code>Net::SMTP</code> module. This method is provided by the <code>tlsmail</code> gem and will allow our SMTP connection to use TLS as the authentication method. The other part of the code is pretty straightforward: we simply call the <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/net/smtp/rdoc/Net/SMTP.html#method-c-start">start</a> method with a block, in which we actually send the email with <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/net/smtp/rdoc/Net/SMTP.html#method-i-send_message">send_message</a>. Note that we have to provide the <code>start</code> method with the SMTP info of our Google Mail server account. This includes the server, which will be <code>smtp.gmail.com</code>, the port, which is <code>587</code>, the HELO, which is <code>gmail.com</code> if using a standard account or your domain FQDN if using your own domain, and finally your username and password. For the authentication parameter we have to provide <code>:plain</code> (TLS will be used on top of that).
</p>
<p>
Now let's see how the <code>mailtext</code> string is built. In this case I'll be using a plain text format with two different variants: a simple text email, or an email with an attachment.
</p>
<p>
To send a simple text email, we have to follow the SMTP standard. I took the info from this <a href="http://www.tutorialspoint.com/ruby/ruby_sending_email.htm">tutorialspoint post</a>. Here's the pattern we have to follow to build a compliant string:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">send_plain_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span>
  <span class="n">mailtext</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
From: </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="sh">
To: </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="sh">
Subject: </span><span class="si">#{</span><span class="n">subject</span><span class="si">}</span><span class="sh">

</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="sh">
</span><span class="no">EOF</span>
  <span class="n">send_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mailtext</span>
<span class="k">end</span></code></pre></figure>

</p>
<p>
Note the importance of the indenting here, as the from/to/subject lines must start at the first text column. With this simple method, you can then simply call the method we programmed before with the resulting string as a parameter and the email will be sent. Pretty easy.
</p>
<p>
Sending an attachment is a bit more complicated. As SMTP email is send in plain text, attachments are encoded in base64 strings, and are added to the message string in a special way. Here's how to do it in Ruby:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">send_attachment_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">attachment</span>
<span class="c1"># Read a file and encode it into base64 format</span>
  <span class="k">begin</span>
    <span class="n">filecontent</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>
    <span class="n">encodedcontent</span> <span class="o">=</span> <span class="p">[</span><span class="n">filecontent</span><span class="p">].</span><span class="nf">pack</span><span class="p">(</span><span class="s2">"m"</span><span class="p">)</span>   <span class="c1"># base64</span>
  <span class="k">rescue</span>
    <span class="k">raise</span> <span class="s2">"Could not read file </span><span class="si">#{</span><span class="n">attachment</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">marker</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">...</span><span class="mi">50</span><span class="p">).</span><span class="nf">map</span><span class="p">{</span> <span class="p">(</span><span class="s1">'a'</span><span class="o">..</span><span class="s1">'z'</span><span class="p">).</span><span class="nf">to_a</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">26</span><span class="p">)]</span> <span class="p">}.</span><span class="nf">join</span>
  <span class="n">part1</span> <span class="o">=&lt;&lt;</span><span class="no">EOF</span><span class="sh">
From: </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="sh">
To: </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="sh">
Subject: </span><span class="si">#{</span><span class="n">subject</span><span class="si">}</span><span class="sh">
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">
--</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">
</span><span class="no">EOF</span>

<span class="c1"># Define the message action</span>
  <span class="n">part2</span> <span class="o">=&lt;&lt;</span><span class="no">EOF</span><span class="sh">
Content-Type: text/plain
Content-Transfer-Encoding:8bit

</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="sh">
--</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">
</span><span class="no">EOF</span>

<span class="c1"># Define the attachment section</span>
  <span class="n">part3</span> <span class="o">=&lt;&lt;</span><span class="no">EOF</span><span class="sh">
Content-Type: multipart/mixed; name=</span><span class="se">\"</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span><span class="si">}</span><span class="se">\"</span><span class="sh">
Content-Transfer-Encoding:base64
Content-Disposition: attachment; filename="</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span><span class="si">}</span><span class="sh">"

</span><span class="si">#{</span><span class="n">encodedcontent</span><span class="si">}</span><span class="sh">
--</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">--
</span><span class="no">EOF</span>

  <span class="n">mailtext</span> <span class="o">=</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span> <span class="o">+</span> <span class="n">part3</span>

  <span class="n">send_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mailtext</span>
<span class="k">end</span></code></pre></figure>

</p>
<p>
As you can see, in the first place the file is read and converted to a base64 string. After that, the message is generated. SMTP uses a special unique marker to delimit the attachment from the rest of the text. In here we use the line <code>(0...50).map{ ('a'..'z').to_a[rand(26)] }.join</code> (extracted from StackOverflow) to generate a 50 char length random string. Although it's very unlikely to happen, we should check that this random string does not appear anywhere else in the message body or the base64 converted attached file before using it as a delimiter.
</p>
<p>
After that, the rest of the message is built, specifying it has an attachment and its delimiter in the following lines:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">MIME</span><span class="o">-</span><span class="no">Version</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="no">Content</span><span class="o">-</span><span class="no">Type</span><span class="p">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">mixed</span><span class="p">;</span> <span class="n">boundary</span><span class="o">=</span><span class="c1">#{marker}</span>
<span class="o">--</span><span class="c1">#{marker}</span></code></pre></figure>

</p>
<p>
The file is actually attached some lines below. After that, we can pass this new string to the method that sends the email, and all done.
</p>
<p>
Now, because our SMTP info can be sensitive (it contains our username and our password), it might not be a good idea to just hardcode this info in the email sending script. That's why I've used a yaml serialized hash to store this info, so we can load it at any time. Doing this is really easy with the <code>yaml</code> gem:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">smtp_info</span> <span class="o">=</span> 
    <span class="k">begin</span>
      <span class="no">YAML</span><span class="p">.</span><span class="nf">load_file</span><span class="p">(</span><span class="s2">"/path/to/your/smtpinfo"</span><span class="p">)</span>
    <span class="k">rescue</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Could not find SMTP info"</span>
      <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">end</span></code></pre></figure>

</p>
<p>
An example file would look like this:
</p>
<p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="s">:smtp_server: smtp.gmail.com</span>
<span class="s">:port: </span><span class="m">587</span>
<span class="s">:helo: gmail.com</span>
<span class="s">:username: user@gmail.com</span>
<span class="s">:password: your_password_here</span>
<span class="s">:authentication: :plain</span></code></pre></figure>

</p>
<p>
Now that we have all the parts programmed, we should only pack it a little so it can be of use as a library. The following code contains a simple script with a class to send the emails and a little program that reads parameters from the command line:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'net/smtp'</span>
<span class="nb">require</span> <span class="s1">'tlsmail'</span>
<span class="nb">require</span> <span class="s1">'yaml'</span>

<span class="k">class</span> <span class="nc">SMTPGoogleMailer</span>
  <span class="nb">attr_accessor</span> <span class="ss">:smtp_info</span>

  <span class="k">def</span> <span class="nf">send_plain_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span>
    <span class="n">mailtext</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
From: </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="sh">
To: </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="sh">
Subject: </span><span class="si">#{</span><span class="n">subject</span><span class="si">}</span><span class="sh">

</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="sh">
</span><span class="no">EOF</span>
    <span class="n">send_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mailtext</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">send_attachment_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">attachment</span>
<span class="c1"># Read a file and encode it into base64 format</span>
    <span class="k">begin</span>
      <span class="n">filecontent</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>
      <span class="n">encodedcontent</span> <span class="o">=</span> <span class="p">[</span><span class="n">filecontent</span><span class="p">].</span><span class="nf">pack</span><span class="p">(</span><span class="s2">"m"</span><span class="p">)</span>   <span class="c1"># base64</span>
    <span class="k">rescue</span>
      <span class="k">raise</span> <span class="s2">"Could not read file </span><span class="si">#{</span><span class="n">attachment</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="n">marker</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">...</span><span class="mi">50</span><span class="p">).</span><span class="nf">map</span><span class="p">{</span> <span class="p">(</span><span class="s1">'a'</span><span class="o">..</span><span class="s1">'z'</span><span class="p">).</span><span class="nf">to_a</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">26</span><span class="p">)]</span> <span class="p">}.</span><span class="nf">join</span>
    <span class="n">part1</span> <span class="o">=&lt;&lt;</span><span class="no">EOF</span><span class="sh">
From: </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="sh">
To: </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="sh">
Subject: </span><span class="si">#{</span><span class="n">subject</span><span class="si">}</span><span class="sh">
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">
--</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">
</span><span class="no">EOF</span>

<span class="c1"># Define the message action</span>
    <span class="n">part2</span> <span class="o">=&lt;&lt;</span><span class="no">EOF</span><span class="sh">
Content-Type: text/plain
Content-Transfer-Encoding:8bit

</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="sh">
--</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">
</span><span class="no">EOF</span>

<span class="c1"># Define the attachment section</span>
    <span class="n">part3</span> <span class="o">=&lt;&lt;</span><span class="no">EOF</span><span class="sh">
Content-Type: multipart/mixed; name=</span><span class="se">\"</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span><span class="si">}</span><span class="se">\"</span><span class="sh">
Content-Transfer-Encoding:base64
Content-Disposition: attachment; filename="</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span><span class="si">}</span><span class="sh">"

</span><span class="si">#{</span><span class="n">encodedcontent</span><span class="si">}</span><span class="sh">
--</span><span class="si">#{</span><span class="n">marker</span><span class="si">}</span><span class="sh">--
</span><span class="no">EOF</span>

    <span class="n">mailtext</span> <span class="o">=</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span> <span class="o">+</span> <span class="n">part3</span>

    <span class="n">send_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mailtext</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">send_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mailtext</span>
    <span class="k">begin</span> 
      <span class="no">Net</span><span class="o">::</span><span class="no">SMTP</span><span class="p">.</span><span class="nf">enable_tls</span><span class="p">(</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_NONE</span><span class="p">)</span>
      <span class="no">Net</span><span class="o">::</span><span class="no">SMTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:smtp_server</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:port</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:helo</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:username</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:password</span><span class="p">],</span> <span class="vi">@smtp_info</span><span class="p">[</span><span class="ss">:authentication</span><span class="p">])</span> <span class="k">do</span> <span class="o">|</span><span class="n">smtp</span><span class="o">|</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">send_message</span> <span class="n">mailtext</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>  
      <span class="k">raise</span> <span class="s2">"Exception occured: </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2"> "</span>
      <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">end</span>  
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">if</span> <span class="kp">__FILE__</span> <span class="o">==</span> <span class="vg">$0</span>
  <span class="n">from</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">to</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">subject</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">body</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
  <span class="n">attachment</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
  <span class="n">smtp_info</span> <span class="o">=</span> 
    <span class="k">begin</span>
      <span class="no">YAML</span><span class="p">.</span><span class="nf">load_file</span><span class="p">(</span><span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">rescue</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Could not find SMTP info"</span>
      <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">end</span>

  <span class="n">mailer</span> <span class="o">=</span> <span class="no">SMTPGoogleMailer</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">mailer</span><span class="p">.</span><span class="nf">smtp_info</span> <span class="o">=</span> <span class="n">smtp_info</span>

  <span class="k">if</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">begin</span>
      <span class="n">mailer</span><span class="p">.</span><span class="nf">send_attachment_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">attachment</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Something went wrong: </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span>
      <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="n">mailer</span><span class="p">.</span><span class="nf">send_plain_email</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Something went wrong: </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span>
      <span class="nb">exit</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

</p>
<p>
And that's all! You can use the script as a standalone command to send an email with some command line arguments or just require it in your ruby script and use the class to send the messages.
</p>

        </div></li><li>
        <header class="post-header">
          <h1 class="post-title"><a class="post-link" href="/2012/07/16/ruby-rails-varnish-user-dependent-content/">Ruby on Rails, Varnish and user dependent content</a></h1>

          <p class="post-meta">
            Jul 16, 2012• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span> • <a href="/categories/uncategorized/">Uncategorized</a> • <a href="/tags/cache/">cache</a>, <a href="/tags/ruby-on-rails/">ruby on rails</a>, <a href="/tags/varnish/">varnish</a></p>
        </header>

        <div class="post-content">
          <p>
Ruby on Rails performance is a topic that has been widely discussed. Whichever the conclusion you want to make about all the resources out there, the chances you'll be having to use a cache server in front of your application servers are pretty high. <a href="https://www.varnish-cache.org/" title="Varnish">Varnish</a> is a nice option when having to deal with this architecture: it has lots of options and flexibility, and its performance is really good, too.
</p>
<p>
However, adding a cache server in front of your application can lead to problems when the page you are serving has user dependent content. Let's see what can we do to solve this problem.
</p>

        </div><p class="post-continue">
            <a href="/2012/07/16/ruby-rails-varnish-user-dependent-content/">Read on &rarr;</a>
          </p></li><li>
        <header class="post-header">
          <h1 class="post-title"><a class="post-link" href="/2012/06/11/ruby-implementation-fizzbuzz-test-enumerator-class/">A Ruby implementation of the FizzBuzz test using the Enumerator class</a></h1>

          <p class="post-meta">
            Jun 11, 2012• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bernat Ràfales</span></span> • <a href="/categories/uncategorized/">Uncategorized</a> • <a href="/tags/enumerator/">enumerator</a>, <a href="/tags/fizzbuzz/">fizzbuzz</a>, <a href="/tags/rspec/">rspec</a>, <a href="/tags/ruby/">ruby</a></p>
        </header>

        <div class="post-content">
          <p>
Some days ago I learnt about The FizzBuzz Test and did a simple implementation in Ruby. The FizzBuzz test is a simple algorithm that is supposed to do the following:
</p>
<p>
For each number from 1 to 100:
<ul>
  <li>If the number is divisible by 3, print "Fizz"</li>
  <li>If the number is divisible by 5, print "Buzz"</li>
  <li>If the number is divisible by both 3 and 5, print "FizzBuzz"</li>
  <li>Otherwise print the number</li>
</ul>
</p>
<p>
I was just reading about how you can use the <a href="http://www.ruby-doc.org/core-1.9.3/Enumerator.html">Enumerator</a> class to have generators in the <a href="http://pragprog.com/book/ruby3/programming-ruby-1-9">Programming Ruby 1.9</a> book, and thought that a good implementation could be done using just an Enumerator, so here it is, along with a simple RSpect test:
</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">FizzBuzz</span> <span class="o">=</span> <span class="no">Enumerator</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">yielder</span><span class="o">|</span>
  <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">yielder</span><span class="p">.</span><span class="nf">yield</span> <span class="s2">"FizzBuzz"</span>
      <span class="k">else</span>
        <span class="n">yielder</span><span class="p">.</span><span class="nf">yield</span> <span class="s2">"Fizz"</span>
      <span class="k">end</span>
    <span class="k">elsif</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="n">yielder</span><span class="p">.</span><span class="nf">yield</span> <span class="s2">"Buzz"</span>
    <span class="k">else</span> 
      <span class="n">yielder</span><span class="p">.</span><span class="nf">yield</span> <span class="n">count</span>
    <span class="k">end</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

</p>
<p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'fizzbuzz'</span>

<span class="n">describe</span> <span class="no">FizzBuzz</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@fizzbuzzes</span> <span class="o">=</span> <span class="no">FizzBuzz</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"returns 'Fizz' for all multiples of 3"</span> <span class="k">do</span>
    <span class="vi">@fizzbuzzes</span><span class="p">[</span><span class="mi">3</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">should</span> <span class="o">==</span> <span class="s1">'Fizz'</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"returns 'Buzz' for all multiples of 5"</span> <span class="k">do</span>
    <span class="vi">@fizzbuzzes</span><span class="p">[</span><span class="mi">5</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">should</span> <span class="o">==</span> <span class="s1">'Buzz'</span>

  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"returns 'FizzBuzz' for all multiples of 3 and 5"</span> <span class="k">do</span>
    <span class="vi">@fizzbuzzes</span><span class="p">[</span><span class="mi">60</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nf">should</span> <span class="o">==</span> <span class="s1">'FizzBuzz'</span>

  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"returns the passed number if not a multiple of 3 or 5"</span> <span class="k">do</span>
    <span class="vi">@fizzbuzzes</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nf">should</span> <span class="o">==</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

</p>
<p>
You can also find the code in its GitHub repository: <a href="https://github.com/brafales/ruby-fizzbuzz">https://github.com/brafales/ruby-fizzbuzz</a>.
</p>

        </div></li></ul>
  <div class="pagination">
    
      <a class="previous" href="/posts/22/">&laquo; Older</a>
    

    
      <a class="next" href="/posts/20/">Newer &raquo;</a>
    
  </div>

</div>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Powered by <a href="https://jekyllrb.com">Jekyll</a>. Theme based on <a href="https://github.com/yous/whiteglass">whiteglass</a>
<br>
Subscribe via <a href="https://thinkingeek.com/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
